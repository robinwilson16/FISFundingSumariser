CREATE PROCEDURE SPR_FIS_FundingData_1718
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn INT,
	@IsFinalReturn BIT,
	@Split1619Funding BIT,
	@1619ALSFundingPercent DECIMAL(3,2),
	@IncludeHEAdvLoanPossIncome BIT,
	@IncludeAdvLoanBursaryIncome BIT,
	@AEBCombinedAuthorityName NVARCHAR(200),
	@FutureAchieveWeighting DECIMAL(3,2),
    @FISOutputTableLocation NVARCHAR(200),
	@ProviderFieldFacLocation CHAR(1),
	@ProviderFieldTeamLocation CHAR(1),
	@ProviderFieldCostCentreLocation CHAR(1),
	@ProviderFieldCourseLocation CHAR(1),
	@OverrideEngFac NVARCHAR(50),
	@OverrideMatFac NVARCHAR(50),
	@OverrideEngTeam NVARCHAR(50),
	@OverrideMatTeam NVARCHAR(50),
	@OverrideEngCostCentre NVARCHAR(50),
	@OverrideMatCostCentre NVARCHAR(50),
	@OverridePartnerFac NVARCHAR(50),
	@OverridePartnerTeam NVARCHAR(50),
	@OverridePartnerCostCentre NVARCHAR(50)
AS
BEGIN
	SET NOCOUNT ON;

	--DECLARE @FISDatabase NVARCHAR(50) = 'FIS_1819_R10_2'
	--DECLARE @AcademicYear NVARCHAR(5) = '18/19'
	--DECLARE @ILRReturn NVARCHAR(2) = '10'
	--DECLARE @IsFinalReturn BIT = 0
	--DECLARE @Split1619Funding BIT = 1
	--DECLARE @1619ALSFundingPercent DECIMAL(3,2) = 0.03
	--DECLARE @IncludeHEAdvLoanPossIncome BIT = 1
	--DECLARE @IncludeAdvLoanBursaryIncome BIT = 1
	--DECLARE @AEBCombinedAuthorityName NVARCHAR(200) = 'AEB'
	--DECLARE @FutureAchieveWeighting DECIMAL(3,2) = 0.75
	--DECLARE @FISOutputTableLocation NVARCHAR(200) = 'ProSolutionReports.dbo.'
	--DECLARE @ProviderFieldFacLocation NCHAR(1) = 'D'
	--DECLARE @ProviderFieldTeamLocation NCHAR(1) = 'C'
	--DECLARE @ProviderFieldCostCentreLocation NCHAR(1) = 'B'
	--DECLARE @ProviderFieldCourseLocation NCHAR(1) = 'A'
	--DECLARE @OverrideEngFac NVARCHAR(50) = 'F05'
	--DECLARE @OverrideMatFac NVARCHAR(50) = 'F05'
	--DECLARE @OverrideEngTeam NVARCHAR(50) = 'T01'
	--DECLARE @OverrideMatTeam NVARCHAR(50) = 'T02'
	--DECLARE @OverrideEngCostCentre NVARCHAR(50) = '4461'
	--DECLARE @OverrideMatCostCentre NVARCHAR(50) = '4462'
	--DECLARE @OverridePartnerFac NVARCHAR(50) = 'F00'
	--DECLARE @OverridePartnerTeam NVARCHAR(50) = 'T00'
	--DECLARE @OverridePartnerCostCentre NVARCHAR(50) = ''

	DECLARE @SQLString NVARCHAR(MAX);
    DECLARE @SQLParams NVARCHAR(MAX);

	SET @SQLString = 
        N'
		IF OBJECT_ID(''tempdb.dbo.#LearningAims'', ''U'') IS NOT NULL
			DROP TABLE #LearningAims; 

		IF OBJECT_ID(''tempdb.dbo.#CollegeStructure'', ''U'') IS NOT NULL
			DROP TABLE #CollegeStructure; 

		IF OBJECT_ID(''tempdb.dbo.#CourseHours'', ''U'') IS NOT NULL
			DROP TABLE #CourseHours; 

		IF OBJECT_ID(''tempdb.dbo.#Employers'', ''U'') IS NOT NULL
			DROP TABLE #Employers; 

		IF OBJECT_ID(''tempdb.dbo.#Partners'', ''U'') IS NOT NULL
			DROP TABLE #Partners; 

		IF OBJECT_ID(''tempdb.dbo.#Frameworks'', ''U'') IS NOT NULL
			DROP TABLE #Frameworks; 

		IF OBJECT_ID(''tempdb.dbo.#Standards'', ''U'') IS NOT NULL
			DROP TABLE #Standards; 

		IF OBJECT_ID(''tempdb.dbo.#PostCodes'', ''U'') IS NOT NULL
			DROP TABLE #PostCodes; 

		SELECT
			AIM.SSA1Code,
			AIM.SSA1Name,
			AIM.SSA2Code,
			AIM.SSA2Name,
			AIM.AimCode,
			AIM.AimTitle,
			AIM.AimLevel,
			AIM.AwardBodyCode
		INTO #LearningAims
		FROM FIS_LearningAims AIM

		SELECT
			CS.AcademicYear,
			CS.SiteCode,
			CS.SiteName,
			CS.FacCode,
			CS.FacName,
			CS.TeamCode,
			CS.TeamName,
			CS.CostCentreCode,
			CS.CourseCode,
			CS.CourseTitle,
			CS.ProvSpecField
		INTO #CollegeStructure
		FROM FIS_CollegeStructure CS
		WHERE
			CS.AcademicYear = @AcademicYear

		SELECT
			HRS.AcademicYear,
			HRS.ProvSpecField,
			HRS.CourseCode,
			HRS.PLH,
			HRS.EEP
		INTO #CourseHours
		FROM FIS_CourseHours HRS
		WHERE
			HRS.AcademicYear = @AcademicYear

		SELECT
			EMP.EmployerEDRS,
			EMP.EmployerName
		INTO #Employers
		FROM FIS_Employers EMP

		SELECT
			PAR.PartnerUKPRN,
			PAR.PartnerName
		INTO #Partners
		FROM FIS_Partners PAR

		SELECT
			FW.FrameworkCode,
			FW.FrameworkName
		INTO #Frameworks
		FROM FIS_Frameworks FW

		SELECT
			STD.StandardCode,
			STD.StandardName
		INTO #Standards
		FROM FIS_Standards STD

		SELECT
			PC.PostCode,
			PC.WardCode,
			PC.WardName,
			PC.DistrictCode,
			PC.DistrictName,
			PC.LEACode,
			PC.LEAName,
			PC.Uplift1619,
			PC.UpliftAdult,
			PC.UpliftApp
		INTO #PostCodes
		FROM FIS_PostCodes PC
	'

	SET @SQLString += 
        N'
		INSERT INTO ' + @FISOutputTableLocation + 'FIS_FundingData WITH (TABLOCKX)
		SELECT
			AcademicYear = @AcademicYear,
            ProviderNumber = SRC.UKPRN,
			ProviderName = PROV.ProviderName,
			ILRReturn = ''R'' + FORMAT ( @ILRReturn, ''#00'' ),
			IsFinalReturn = @IsFinalReturn,
			ILRReturnDate = SRC.DateTime,
			SQLDatabase = ''' + @FISDatabase + ''',
			Is1619FundingSplit = CASE WHEN LD.FundModel = ''25'' AND @Split1619Funding = 1 AND COALESCE ( HRS.PLH, 0 ) > 0 THEN 1 ELSE 0 END,
			ALS1619FundingPercent = @1619ALSFundingPercent,
			InvalidLearners = INV.InvalidLearners,

			LearnerRef = L.LearnRefNumber,
			Surname = L.FamilyName,
			Forename = L.GivenNames,
			DOB = L.DateOfBirth,
			Age31Aug = DV.Learn_Age31Aug,
			ULN = L.ULN,
			Address1 = L.AddLine1,
			Address2 = L.AddLine2,
			Address3 = L.AddLine3,
			Address4 = L.AddLine4,
			PostCodeLearner = L.Postcode,
			Tel = L.TelNo,
			Email = L.Email,
			PostCodeWardCode = PC.WardCode,
			PostCodeWardName = PC.WardName,
			PostCodeDistrictCode = PC.DistrictCode,
			PostCodeDistrictName = PC.DistrictName,
			PostCodeLEACode = PC.LEACode,
			PostCodeLEAName = PC.LEAName,
			PostCode1619Uplift = COALESCE ( PC.Uplift1619, 1 ),
			PostCodeAdultUplift = COALESCE ( PC.UpliftAdult, 1 ),
			PostCodeAppUplift = COALESCE ( PC.UpliftApp, 1 ),
			PostCodeUpliftApplied =
				CASE
					WHEN LD.FundModel = ''25'' THEN COALESCE ( PC.Uplift1619, 1 )
					WHEN LD.FundModel = ''35'' AND LD.FworkCode IS NULL THEN COALESCE ( PC.UpliftAdult, 1 )
					WHEN LD.FundModel = ''35'' AND LD.FworkCode IS NOT NULL THEN COALESCE ( PC.UpliftApp, 1 )
					WHEN LD.FundModel = ''35'' THEN COALESCE ( PC.UpliftApp, 1 )
					WHEN LD.FundModel = ''36'' THEN COALESCE ( PC.UpliftApp, 1 )
					ELSE 1
				END,
			EmpStatusCode = EMP.EmpStatusCode,
			EmpStatusName = EMP.EmpStatusName,
			EmpStatusAppliesDate = EMP.EmpStatusAppliesDate,
			EmpStatusEmployerID = EMP.EmployerID,
			LengthOfEmploy = ESM.LOE,
			LengthOfUnemploy = ESM.LOU,
			BenefitStatusInd = ESM.BSI,
			SmallEmployer = ESM.SEM,
			SelfEmployInd = ESM.SEI,
			EmployIntensityInd = ESM.EII,
			IsFirstFullLevel2 = DV.Learn_FirstFullLevel2,
			IsFirstFullLevel3 = DV.Learn_FirstFullLevel3,
			PrimaryLLDDHealthProblem = LLDD.LLDDCat,
			DPOutcomeType = OC.DPOutcomeType,
			DPOutcomeCode = OC.DPOutcomeCode,
			DPOutcomeStartDate = OC.DPOutcomeStartDate,
			DPOutcomeEndDate = OC.DPOutcomeEndDate,
			DPOutcomeCollectionDate = OC.DPOutcomeCollectionDate,

			FundLine = 
				COALESCE ( 
					CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
					FM25.FundLine, 
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN ALB.FundLine END,
					FM36P.FundLineType,
					FM35.FundLine,
					CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
					CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
				),
    '

    SET @SQLString += 
        N'
			FundLineSummary =
				CASE
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) IN (
							''16-19 Students (excluding High Needs Students)'',
							 ''16-19 High Needs Students'',
							 ''19-24 Students with an EHCP'',
							 ''19+ Continuing Students (excluding EHCP)''
						)
							 THEN ''16-19 Funding''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Employer on App Service%''
							 THEN ''Apprenticeships (App Service)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''Apprenticeships (Reformed)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''Apprenticeships (Reformed)''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Employer on App Service%''
							 THEN ''Apprenticeships (App Service)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''Apprenticeships (Reformed)''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''Apprenticeships (Reformed)''
                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''Loan%''
                            THEN ''Loans''

                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''Higher Education%''
                            THEN ''HE''

                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%AEB%''
                            THEN ''Adult - ESFA''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Adult Education%''
                            THEN ''Adult - Devolved''

                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''24% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''Apprenticeships (Legacy)''

					ELSE 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						)
				END,
     '

    SET @SQLString += 
        N'
			FundLineDetail =
				CASE
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) IN (
							''16-19 Students (excluding High Needs Students)'',
							 ''16-19 High Needs Students'',
							 ''19-24 Students with an EHCP'',
							 ''19+ Continuing Students (excluding EHCP)''
						)
							 THEN ''16-19 Students (inc. High Needs)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''16-18 Apprenticeship Non-Levy''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''19+ Apprenticeship Non-Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship Levy''
                    WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''24% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship''
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%AEB%''
                            THEN ''AEB - ESFA''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Adult Education%''
                            THEN @AEBCombinedAuthorityName

					ELSE 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
							FM36P.FundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						)
				END,
    '

    SET @SQLString += 
        N'
			FundModel = LD.FundModel,
			HEFullPartTime = 
				CASE
					WHEN HE.MODESTUD = 1 THEN ''Full Time''
					WHEN HE.MODESTUD = 3 THEN ''Part Time''
					WHEN HE.MODESTUD = 2 THEN ''Year Out''
					ELSE NULL
				END,
			SortOrder =
				CASE
					COALESCE ( 
						CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
						FM25.FundLine, 
						CASE WHEN ALB.AdvLoan = 1 THEN ''Advanced Learner Loan (ALL)'' END,
						FM36P.FundLineType,
						FM35.FundLine,
						CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
						CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
					)
					WHEN ''16-19 Students (excluding High Needs Students)'' THEN 1
					WHEN ''16-19 High Needs Students'' THEN 2
					WHEN ''19-24 Students with an EHCP'' THEN 3
					WHEN ''Advanced Learner Loan (ALL)'' THEN 4
					WHEN ''Advanced Learner Loans Bursary'' THEN 5
					WHEN ''19+ Continuing Students (excluding EHCP)'' THEN 6
					WHEN ''AEB - Other Learning (non-procured)'' THEN 7
					WHEN ''ESFA AEB - Adult Skills (non-procured)'' THEN 8
					WHEN ''Adult Education - Eligible for MCA/GLA funding (non-procured)'' THEN 9
					WHEN ''Higher Education'' THEN 10
					WHEN ''Full Cost'' THEN 11
					ELSE 99
				END,
	'

    SET @SQLString += 
        N'
			IsFunded = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ),
			IsMainAim = 
				CASE
					WHEN LD.AimSeqNumber = MA.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsMainAimInFundModel = 
				CASE
					WHEN LD.AimSeqNumber = MAFM.AimSeqNumber THEN 1
					ELSE 0
				END,
			IsAdvLearnLoan = ALB.AdvLoan,
			IsAdvLearnLoanBursary = CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine <> ''None'' THEN 1 ELSE 0 END,
			RateBand = HRS.RateBand,
			GCSEMathsGrade = L.MathGrade,
			GCSEEnglishGrade = L.EngGrade,
			CofMaths = FM25.ConditionOfFundingMaths,
			CofEnglish = FM25.ConditionOfFundingEnglish,
			CofMathsMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths'' THEN 0
                    WHEN FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths'' THEN 0
					ELSE 1
				END,
			CofEnglishMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' THEN 0
                    WHEN FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' THEN 0
					ELSE 1
				END,
			CofMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN 
						FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' 
                        OR FM25.ConditionOfFundingEnglish = ''Has English GCSE Grade D or Grade 3, Not studying GCSE English'' 
						OR FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths''
                        OR FM25.ConditionOfFundingMaths = ''Has Maths GCSE Grade D or Grade 3, Not studying GCSE Maths''
						THEN 0
					ELSE 1
				END,

			PostCodeDelivery = LD.DelLocPostCode,
			CampusID = NULL,
			SiteCode = COALESCE ( CS.SiteCode, ''-'' ),
			SiteName = COALESCE ( CS.SiteName, ''-- Unknown --'' ),
    '

    SET @SQLString += 
        N'
			FacCode = 
				COALESCE (
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%English%'' THEN @OverrideEngFac END,
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%Math%'' THEN @OverrideMatFac END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN @OverridePartnerFac END,
					CS.FacCode,
					FAC.FacCode,
					''-''
				),
			FacName = 
				COALESCE (
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%English%'' THEN FENG.FacName END,
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%Math%'' THEN FMAT.FacName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN FPAR.FacName END,
					CS.FacName,
					FAC.FacName,
					''-- Unknown --''
				),
			MainFacCode = COALESCE ( CSM.FacCode, MA.FacCode, ''-'' ),
			MainFacName = COALESCE ( CSM.FacName, ''-- Unknown --'' ),
			MainTeamCode = COALESCE ( CSM.TeamCode, MA.TeamCode, ''-'' ),
			MainTeamName = COALESCE ( CSM.TeamName, ''-- Unknown --'' ),
			TeamCode = 
				COALESCE (
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%English%'' THEN @OverrideEngTeam END,
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%Math%'' THEN @OverrideMatTeam END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN @OverridePartnerTeam END,
					CS.TeamCode,
					TEAM.TeamCode,
					''-''
				),
			TeamName = 
				COALESCE (
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%English%'' THEN TENG.TeamName END,
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%Math%'' THEN TMAT.TeamName END,
					CASE WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN TPAR.TeamName END,
					CS.TeamName,
					TEAM.TeamName,
					''-- Unknown --''
				),
	'

    SET @SQLString += 
        N'
			CostCentre = 
				COALESCE (
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%English%'' THEN @OverrideEngCostCentre END,
					CASE WHEN LD.LearnAimRef IN (''0003'', ''2999'', ''1439'') AND  AIM.AimTitle LIKE ''%Math%'' THEN @OverrideMatCostCentre END,
					CS.CostCentreCode,
					''-''
				),
			FacCodeOrig = 
				CASE
					WHEN @ProviderFieldFacLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldFacLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldFacLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldFacLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''-''
				END,
			FacNameOrig = COALESCE ( CS.FacName, ''--Unknown --'' ),
			TeamCodeOrig = 
				CASE
					WHEN @ProviderFieldTeamLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldTeamLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldTeamLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldTeamLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''-''
				END,
			TeamNameOrig = COALESCE ( CS.TeamName, ''--Unknown --'' ),
			CostCentreOrig = 
				CASE
					WHEN @ProviderFieldCostCentreLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCostCentreLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCostCentreLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCostCentreLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''-''
				END,
			SSA1Code = AIM.SSA1Code,
			SSA1Title = AIM.SSA1Name,
			SSA2Code = AIM.SSA2Code,
			SSA2Title = AIM.SSA2Name,
			CourseCode = 
				CASE
					WHEN @ProviderFieldCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
					ELSE ''-'' 
				END,
			CourseTitle = CS.CourseTitle,

			AimSequence = LD.AimSeqNumber,
			AimType = LD.AimType,
			AimCode = LD.LearnAimRef,
			AimTitle = AIM.AimTitle,
			StartDate = LD.LearnStartDate,
			ExpEndDate = LD.LearnPlanEndDate,
			ActEndDate = LD.LearnActEndDate,
			LearnerPLH = COALESCE ( L.PlanLearnHours, 0 ),
			LearnerEEP = COALESCE ( L.PlanEEPHours, 0 ),
			FM25PLHAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN CH.PLH END, 0 ),
			FM25EEPAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN CH.EEP END, 0 ),
			FM25PLHAllAims = COALESCE ( HRS.PLH, 0 ),
			FM25EEPAllAims = COALESCE ( HRS.EEP, 0 ),
    '

    SET @SQLString += 
        N'
			CompletionCode = LD.CompStatus,
			CompletionDesc = 
				CASE
					WHEN LD.CompStatus = ''1'' THEN ''Continuing''
					WHEN LD.CompStatus = ''2'' THEN ''Completed''
					WHEN LD.CompStatus = ''3'' THEN ''Withdrawn''
					WHEN LD.CompStatus = ''6'' THEN ''Break in Learning''
					ELSE ''Unknown''
				END,
			OutcomeCode = LD.Outcome,
			OutcomeDesc = 
				CASE
					WHEN LD.Outcome IS NULL THEN NULL
					WHEN LD.Outcome = ''1'' THEN ''Achieved''
					WHEN LD.Outcome = ''2'' THEN ''Partialy Achieved''
					WHEN LD.Outcome = ''3'' THEN ''Fail''
					WHEN LD.Outcome = ''8'' THEN ''Unknown''
					ELSE ''Unknown''
				END,
			WithdrawReason = LD.WithdrawReason,
			Grade = LD.OutGrade,
			AwardBody = AIM.AwardBodyCode,

			FrameworkCode = LD.FworkCode,
			FrameworkName = COALESCE ( FW.FrameworkName, ''-- Unknown --'' ),
			EmployerID = 
				CASE
					WHEN LDR.LearnDel_EmpID = -1 THEN NULL
					ELSE LDR.LearnDel_EmpID
				END,
			EmployerName = EMPN.EmployerName,
			PartnerCode = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END,
			PartnerName = PAR.PartnerName,

			AimValue = FM35.AimValue,
			ProgWeightFactor = FM35.ApplicProgWeightFact,
			UnweightFundRate = FM35.ApplicUnweightFundRate,
			WeightFundRate = FM35.ApplicWeightFundRate,
			NVQLevel = AIM.AimLevel,
			CoFundingIndicator = 
				CASE
					WHEN FFI.LearnDelFAMCode IS NULL THEN NULL
					WHEN FFI.LearnDelFAMCode = ''1'' THEN ''Full''
					WHEN FFI.LearnDelFAMCode = ''2'' THEN ''Co''
					ELSE NULL
				END,
			IsCarryIn = 
				CASE
					WHEN CAST ( LD.LearnStartDate AS DATE ) <= ''20'' + LEFT ( @AcademicYear, 2) + ''-08-01'' THEN 1
					ELSE 0
				END,
			HEQualEnt3 = HE.QUALENT3,
			HESoc2000 = HE.SOC2000,
			HESec = HE.SEC,
			HEUCASAppID = HE.UCASAPPID,
			HETypeYr = HE.TYPEYR,
			HEModeStu = HE.MODESTUD,
			HEFundLev = HE.FUNDLEV,
			HEFundComp = HE.FUNDCOMP,
			HEStuLoad = HE.STULOAD,
			HEYearStu = HE.YEARSTU,
			EnrolmentID = PSDMC.ProvSpecDelMon,
			FM25TotFund = COALESCE ( HRS.OnProgPayment, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) * @ILRReturn END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundToPeriod END, FM35P.OnProgPaymentToPeriod, FM36P.OnProgPaymentToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * @ILRReturn, 0 ),
			LearnSuppPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) * @ILRReturn END, FM35P.LearnSuppPaymentToPeriod, FM36P.LearnSuppPaymentToPeriod, 0 ),
			AchCompPaymentToPeriod = COALESCE ( FM35P.AchCompPaymentToPeriod, FM36P.AchCompPaymentToPeriod, 0 ),
			BalancePaymentToPeriod = COALESCE ( FM35P.BalancePaymentToPeriod, FM36P.BalancePaymentToPeriod, 0 ),
			EmpOutcomePayToPeriod = COALESCE ( FM35P.EmpOutcomePayToPeriod, 0 ),
			OtherPaymentToPeriod = COALESCE ( FM36P.OtherPaymentToPeriod, 0 ),
			TotFundToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * @ILRReturn END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundToPeriod END, FM35P.TotFundToPeriod, FM36P.TotFundToPeriod, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * @ILRReturn, 0 ),

			OnProgPayment6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFund6Mon END, FM35P.OnProgPayment6Mon, FM36P.OnProgPayment6Mon, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
			LearnSuppPayment6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) * 6 END, FM35P.LearnSuppPayment6Mon, FM36P.LearnSuppPayment6Mon, 0 ),
			AchCompPayment6Mon = COALESCE ( FM35P.AchCompPayment6Mon, FM36P.AchCompPayment6Mon, 0 ),
			BalancePayment6Mon = COALESCE ( FM35P.BalancePayment6Mon, FM36P.BalancePayment6Mon, 0 ),
			EmpOutcomePay6Mon = COALESCE ( FM35P.EmpOutcomePay6Mon, 0 ),
			OtherPayment6Mon = COALESCE ( FM36P.OtherPayment6Mon, 0 ),
			TotFund6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * 6 END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFund6Mon END, FM35P.TotFund6Mon, FM36P.TotFund6Mon, ( CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12 ) * 6, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundYrEnd END, FM35P.OnProgPaymentYrEnd, FM36P.OnProgPaymentYrEnd, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),
			LearnSuppPaymentYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END END, FM35P.LearnSuppPaymentYrEnd, FM36P.LearnSuppPaymentYrEnd, 0 ),
			AchCompPaymentYrEnd = COALESCE ( FM35P.AchCompPaymentYrEnd, FM36P.AchCompPaymentYrEnd, 0 ),
			BalancePaymentYrEnd = COALESCE ( FM35P.BalancePaymentYrEnd, FM36P.BalancePaymentYrEnd, 0 ),
			EmpOutcomePayYrEnd = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentYrEnd = COALESCE ( FM36P.OtherPaymentYrEnd, 0 ),
			TotFundYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundYrEnd END, FM35P.TotFundYrEnd, FM36P.TotFundYrEnd, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END, 0 ),

			FutureAchCompPayment = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchCompPaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.AchCompPaymentYrEnd )
				END,
			FutureAchieveWeighting = @FutureAchieveWeighting,
			FutureAchCompPaymentWeighted = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchCompPaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.AchCompPaymentYrEnd ) * @FutureAchieveWeighting
				END,

			EmployerContibutionPMRTot = COALESCE ( FM36PE.PriceEpisodeTotalPMRs, 0 ),
			EmployerContibutionPMRCum = COALESCE ( FM36PE.PriceEpisodeCumulativePMRs, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP01 END, FM35P.OnProgPaymentP01, FM36P.OnProgPaymentP01, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP01, FM36P.LearnSuppPaymentP01, 0 ),
			AchCompPaymentP01 = COALESCE ( FM35P.AchCompPaymentP01, FM36P.AchCompPaymentP01, 0 ),
			BalancePaymentP01 = COALESCE ( FM35P.BalancePaymentP01, FM36P.BalancePaymentP01, 0 ),
			EmpOutcomePayP01 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP01 = COALESCE ( FM36P.OtherPaymentP01, 0 ),
			TotFundP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP01 END, FM35P.TotFundP01, FM36P.TotFundP01, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP02 END, FM35P.OnProgPaymentP02, FM36P.OnProgPaymentP02, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP02, FM36P.LearnSuppPaymentP02, 0 ),
			AchCompPaymentP02 = COALESCE ( FM35P.AchCompPaymentP02, FM36P.AchCompPaymentP02, 0 ),
			BalancePaymentP02 = COALESCE ( FM35P.BalancePaymentP02, FM36P.BalancePaymentP02, 0 ),
			EmpOutcomePayP02 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP02 = COALESCE ( FM36P.OtherPaymentP02, 0 ),
			TotFundP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP02 END, FM35P.TotFundP02, FM36P.TotFundP02, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP03 END, FM35P.OnProgPaymentP03, FM36P.OnProgPaymentP03, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP03, FM36P.LearnSuppPaymentP03, 0 ),
			AchCompPaymentP03 = COALESCE ( FM35P.AchCompPaymentP03, FM36P.AchCompPaymentP03, 0 ),
			BalancePaymentP03 = COALESCE ( FM35P.BalancePaymentP03, FM36P.BalancePaymentP03, 0 ),
			EmpOutcomePayP03 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP03 = COALESCE ( FM36P.OtherPaymentP03, 0 ),
			TotFundP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP03 END, FM35P.TotFundP03, FM36P.TotFundP03, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP04 END, FM35P.OnProgPaymentP04, FM36P.OnProgPaymentP04, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP04, FM36P.LearnSuppPaymentP04, 0 ),
			AchCompPaymentP04 = COALESCE ( FM35P.AchCompPaymentP04, FM36P.AchCompPaymentP04, 0 ),
			BalancePaymentP04 = COALESCE ( FM35P.BalancePaymentP04, FM36P.BalancePaymentP04, 0 ),
			EmpOutcomePayP04 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP04 = COALESCE ( FM36P.OtherPaymentP04, 0 ),
			TotFundP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP04 END, FM35P.TotFundP04, FM36P.TotFundP04, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP05 END, FM35P.OnProgPaymentP05, FM36P.OnProgPaymentP05, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP05, FM36P.LearnSuppPaymentP05, 0 ),
			AchCompPaymentP05 = COALESCE ( FM35P.AchCompPaymentP05, FM36P.AchCompPaymentP05, 0 ),
			BalancePaymentP05 = COALESCE ( FM35P.BalancePaymentP05, FM36P.BalancePaymentP05, 0 ),
			EmpOutcomePayP05 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP05 = COALESCE ( FM36P.OtherPaymentP05, 0 ),
			TotFundP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP05 END, FM35P.TotFundP05, FM36P.TotFundP05, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP06 END, FM35P.OnProgPaymentP06, FM36P.OnProgPaymentP06, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP06, FM36P.LearnSuppPaymentP06, 0 ),
			AchCompPaymentP06 = COALESCE ( FM35P.AchCompPaymentP06, FM36P.AchCompPaymentP06, 0 ),
			BalancePaymentP06 = COALESCE ( FM35P.BalancePaymentP06, FM36P.BalancePaymentP06, 0 ),
			EmpOutcomePayP06 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP06 = COALESCE ( FM36P.OtherPaymentP06, 0 ),
			TotFundP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP06 END, FM35P.TotFundP06, FM36P.TotFundP06, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP07 END, FM35P.OnProgPaymentP07, FM36P.OnProgPaymentP07, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP07, FM36P.LearnSuppPaymentP07, 0 ),
			AchCompPaymentP07 = COALESCE ( FM35P.AchCompPaymentP07, FM36P.AchCompPaymentP07, 0 ),
			BalancePaymentP07 = COALESCE ( FM35P.BalancePaymentP07, FM36P.BalancePaymentP07, 0 ),
			EmpOutcomePayP07 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP07 = COALESCE ( FM36P.OtherPaymentP07, 0 ),
			TotFundP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP07 END, FM35P.TotFundP07, FM36P.TotFundP07, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP08 END, FM35P.OnProgPaymentP08, FM36P.OnProgPaymentP08, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP08, FM36P.LearnSuppPaymentP08, 0 ),
			AchCompPaymentP08 = COALESCE ( FM35P.AchCompPaymentP08, FM36P.AchCompPaymentP08, 0 ),
			BalancePaymentP08 = COALESCE ( FM35P.BalancePaymentP08, FM36P.BalancePaymentP08, 0 ),
			EmpOutcomePayP08 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP08 = COALESCE ( FM36P.OtherPaymentP08, 0 ),
			TotFundP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP08 END, FM35P.TotFundP08, FM36P.TotFundP08, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP09 END, FM35P.OnProgPaymentP09, FM36P.OnProgPaymentP09, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP09, FM36P.LearnSuppPaymentP09, 0 ),
			AchCompPaymentP09 = COALESCE ( FM35P.AchCompPaymentP09, FM36P.AchCompPaymentP09, 0 ),
			BalancePaymentP09 = COALESCE ( FM35P.BalancePaymentP09, FM36P.BalancePaymentP09, 0 ),
			EmpOutcomePayP09 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP09 = COALESCE ( FM36P.OtherPaymentP09, 0 ),
			TotFundP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP09 END, FM35P.TotFundP09, FM36P.TotFundP09, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP10 END, FM35P.OnProgPaymentP10, FM36P.OnProgPaymentP10, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP10, FM36P.LearnSuppPaymentP10, 0 ),
			AchCompPaymentP10 = COALESCE ( FM35P.AchCompPaymentP10, FM36P.AchCompPaymentP10, 0 ),
			BalancePaymentP10 = COALESCE ( FM35P.BalancePaymentP10, FM36P.BalancePaymentP10, 0 ),
			EmpOutcomePayP10 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP10 = COALESCE ( FM36P.OtherPaymentP10, 0 ),
			TotFundP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP10 END, FM35P.TotFundP10, FM36P.TotFundP10, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
		'

    SET @SQLString += 
		N'
			OnProgPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP11 END, FM35P.OnProgPaymentP11, FM36P.OnProgPaymentP11, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP11, FM36P.LearnSuppPaymentP11, 0 ),
			AchCompPaymentP11 = COALESCE ( FM35P.AchCompPaymentP11, FM36P.AchCompPaymentP11, 0 ),
			BalancePaymentP11 = COALESCE ( FM35P.BalancePaymentP11, FM36P.BalancePaymentP11, 0 ),
			EmpOutcomePayP11 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP11 = COALESCE ( FM36P.OtherPaymentP11, 0 ),
			TotFundP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP11 END, FM35P.TotFundP11, FM36P.TotFundP11, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),

			OnProgPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.OnProgPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.OnProgPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					FM25.OnProgPayment
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP12 END, FM35P.OnProgPaymentP12, FM36P.OnProgPaymentP12, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 ),
			LearnSuppPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.LearnSuppPayment, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.LearnSuppPayment, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( FM25.OnProgPayment / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END
				END / 12 ) END, FM35P.LearnSuppPaymentP12, FM36P.LearnSuppPaymentP12, 0 ),
			AchCompPaymentP12 = COALESCE ( FM35P.AchCompPaymentP12, FM36P.AchCompPaymentP12, 0 ),
			BalancePaymentP12 = COALESCE ( FM35P.BalancePaymentP12, FM36P.BalancePaymentP12, 0 ),
			EmpOutcomePayP12 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP12 = COALESCE ( FM36P.OtherPaymentP12, 0 ),
			TotFundP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.TotFund, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.TotFund, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN CH.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, CASE WHEN ALB.AdvLoan = 1 AND @IncludeAdvLoanBursaryIncome = 1 THEN ALBP.TotFundP12 END, FM35P.TotFundP12, FM36P.TotFundP12, CASE WHEN @IncludeHEAdvLoanPossIncome = 1 THEN HE.GROSSFEE ELSE 0 END / 12, 0 )

			--INTO FundingDataTemp
	'
    
    SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.dbo.Valid_Learner L
		INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_DV_Learner DV
			ON DV.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_DV_LearningDelivery LDR
			ON LDR.LearnRefNumber = LD.LearnRefNumber
			AND LDR.AimSeqNumber = LD.AimSeqNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Valid_Source SRC
			ON 1 = 1
	'
    
    SET @SQLString += 
		N'
		INNER JOIN (
			SELECT
				LD.LearnRefNumber,
				LD.AimSeqNumber,
				FacCode = 
					CASE
						WHEN @ProviderFieldFacLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				TeamCode = 
					CASE
						WHEN @ProviderFieldTeamLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				CostCentreCode = 
					CASE
						WHEN @ProviderFieldCostCentreLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				CourseCode = 
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				RowNum = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber
						ORDER BY
							COALESCE ( FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) DESC,
                            CASE
                                COALESCE ( 
                                    FM25.FundLine, 
                                    CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
                                    FM36P.FundLineType,
                                    FM35.FundLine,
                                    CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
                                    CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
                                ) 
                                WHEN ''16-19 Students (inc. High Needs)'' THEN 1
                                WHEN ''None'' THEN 9
                                ELSE 2
                            END,
							COALESCE ( LD.ProgType, ''99'' ),
							CASE
								WHEN LD.AimType = 2 THEN 4.5
								ELSE LD.AimType
							END DESC,
							LD.CompStatus,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					)
	'
    
    SET @SQLString += 
        N'
			FROM ' + @FISDatabase + '.dbo.Valid_Learner L
			INNER JOIN ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''

			--16-19
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
				AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
				--AND FM25.StartFund = 1

			--AEB and Apps (Legacy)
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery FM35
				ON FM35.LearnRefNumber = LD.LearnRefNumber
				AND FM35.AimSeqNumber = LD.AimSeqNumber
				--AND FM35.FundStart = 1

			--Apps (Reformed)
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN (
				SELECT
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
				FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery_Period FM36P
				WHERE
					FM36P.FundLineType <> ''None''
				GROUP BY
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
			) FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber

			--Loans and Bursaries
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_ALB_LearningDelivery ALB
				ON ALB.LearnRefNumber = LD.LearnRefNumber
				AND ALB.AimSeqNumber = LD.AimSeqNumber

			--Higher Education
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryHE HE
				ON HE.LearnRefNumber = LD.LearnRefNumber
				AND HE.AimSeqNumber = LD.AimSeqNumber
		) MA
			ON MA.LearnRefNumber = LD.LearnRefNumber
			AND MA.RowNum = 1
	'

	SET @SQLString += 
		N'
		INNER JOIN (
			SELECT
				LD.LearnRefNumber,
				LD.FundModel,
				LD.AimSeqNumber,
				FacCode = 
					CASE
						WHEN @ProviderFieldFacLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldFacLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				TeamCode = 
					CASE
						WHEN @ProviderFieldTeamLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldTeamLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				CostCentreCode = 
					CASE
						WHEN @ProviderFieldCostCentreLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCostCentreLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				CourseCode = 
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
						ELSE ''-''
					END,
				RowNum = 
					ROW_NUMBER () OVER ( 
						PARTITION BY
							LD.LearnRefNumber,
							LD.FundModel
						ORDER BY
							COALESCE ( FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ) DESC,
                            CASE
                                COALESCE ( 
                                    FM25.FundLine, 
                                    CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
                                    FM36P.FundLineType,
                                    FM35.FundLine,
                                    CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
                                    CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
                                ) 
                                WHEN ''16-19 Students (inc. High Needs)'' THEN 1
                                WHEN ''None'' THEN 9
                                ELSE 2
                            END,
							COALESCE ( LD.ProgType, ''99'' ),
							CASE
								WHEN LD.AimType = 2 THEN 4.5
								ELSE LD.AimType
							END DESC,
							LD.CompStatus,
							DATEDIFF ( DAY, LD.LearnStartDate, COALESCE ( LD.LearnActEndDate, LD.LearnPlanEndDate ) ) DESC,
							COALESCE ( L.PlanLearnHours, 0 ) + COALESCE ( L.PlanEEPHours, 0 ) DESC,
							LD.LearnStartDate,
							LD.AimSeqNumber
					)
	'
    
    SET @SQLString += 
        N'
			FROM ' + @FISDatabase + '.dbo.Valid_Learner L
			INNER JOIN ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
				ON LD.LearnRefNumber = L.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''

			--16-19
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
				AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
				--AND FM25.StartFund = 1

			--AEB and Apps (Legacy)
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery FM35
				ON FM35.LearnRefNumber = LD.LearnRefNumber
				AND FM35.AimSeqNumber = LD.AimSeqNumber
				--AND FM35.FundStart = 1

			--Apps (Reformed)
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery FM36
				ON FM36.LearnRefNumber = LD.LearnRefNumber
				AND FM36.AimSeqNumber = LD.AimSeqNumber
			LEFT JOIN (
				SELECT
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
				FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery_Period FM36P
				WHERE
					FM36P.FundLineType <> ''None''
				GROUP BY
					FM36P.LearnRefNumber,
					FM36P.AimSeqNumber,
					FM36P.FundLineType
			) FM36P
				ON FM36P.LearnRefNumber = FM36.LearnRefNumber
				AND FM36P.AimSeqNumber = FM36.AimSeqNumber

			--Loans and Bursaries
			LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_ALB_LearningDelivery ALB
				ON ALB.LearnRefNumber = LD.LearnRefNumber
				AND ALB.AimSeqNumber = LD.AimSeqNumber

			--Higher Education
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryHE HE
				ON HE.LearnRefNumber = LD.LearnRefNumber
				AND HE.AimSeqNumber = LD.AimSeqNumber
		) MAFM
			ON MAFM.LearnRefNumber = LD.LearnRefNumber
			AND MAFM.FundModel = LD.FundModel
			AND MAFM.RowNum = 1
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryFAM FFI
			ON FFI.LearnRefNumber = LD.LearnRefNumber
			AND FFI.AimSeqNumber = LD.AimSeqNumber
			AND FFI.LearnDelFAMType = ''FFI''

		LEFT JOIN (
			SELECT
				LearnerRef = EMP.LearnRefNumber,
				EmpStatusCode = EMP.EmpStat,
				EmpStatusName = 
					CASE
						WHEN EMP.EmpStat = ''10'' THEN ''InEmp''
						WHEN EMP.EmpStat = ''11'' THEN ''NoEmpLooking''
						WHEN EMP.EmpStat = ''12'' THEN ''NoEmpNotLooking''
						WHEN EMP.EmpStat = ''98'' THEN ''Unknown''
						ELSE ''Unknown''
					END,
				EmpStatusAppliesDate = EMP.DateEmpStatApp,
				EmployerID = EMP.EmpId,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							EMP.LearnRefNumber
						ORDER BY
							EMP.DateEmpStatApp DESC
					)
			FROM ' + @FISDatabase + '.dbo.Valid_LearnerEmploymentStatus EMP
		) EMP
			ON EMP.LearnerRef = L.LearnRefNumber
			AND EMP.RowNum = 1
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LLDDandHealthProblem LLDD
			ON LLDD.LearnRefNumber = L.LearnRefNumber
			AND LLDD.PrimaryLLDD = 1
		LEFT JOIN (
			SELECT
				PVT.LearnRefNumber,
				PVT.DateEmpStatApp,
				PVT.LOE,
				PVT.LOU,
				PVT.BSI,
				PVT.SEM,
				PVT.SEI,
				PVT.EII,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							PVT.LearnRefNumber
						ORDER BY
							PVT.DateEmpStatApp DESC
					)
			FROM (
				SELECT
					ESM.LearnRefNumber,
					ESM.DateEmpStatApp,
					ESM.ESMType,
					ESM.ESMCode
				FROM ' + @FISDatabase + '.dbo.Valid_EmploymentStatusMonitoring ESM
			) ESM
			PIVOT (
				MAX ( ESMCode )
				FOR ESMType IN ( [LOE], [LOU], [BSI], [SEM], [SEI], [EII] )
			) AS PVT
		) ESM
			ON ESM.LearnRefNumber = L.LearnRefNumber
			AND ESM.RowNum = 1
    '

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				LearnRefNumber = OC.LearnRefNumber,
				DPOutcomeType = OC.OutType,
				DPOutcomeCode = OC.OutCode,
				DPOutcomeStartDate = OC.OutStartDate,
				DPOutcomeEndDate = OC.OutEndDate,
				DPOutcomeCollectionDate = OC.OutCollDate,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							OC.LearnRefNumber
						ORDER BY
							OC.OutCollDate DESC,
							OC.OutStartDate DESC
					)
			FROM ' + @FISDatabase + '.dbo.Valid_DPOutcome OC
		) OC
			ON OC.LearnRefNumber = L.LearnRefNumber
			AND OC.RowNum = 1
		LEFT JOIN ( --Partner UKPRN not against prog aim so get this here
			SELECT
				LD.LearnRefNumber,
				LD.PartnerUKPRN,
				RowNum = ROW_NUMBER () OVER (
					PARTITION BY
						LD.LearnRefNumber
					ORDER BY
						LD.CompStatus,
						DATEDIFF ( DAY, LD.LearnStartDate, LD.LearnPlanEndDate ) DESC,
						LD.PartnerUKPRN
				)
			FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			WHERE
				LD.PartnerUKPRN IS NOT NULL
		) PTR
			ON PTR.LearnRefNumber = L.LearnRefNumber
			AND PTR.RowNum = 1

		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
			ON PSDMA.LearnRefNumber = LD.LearnRefNumber
			AND PSDMA.AimSeqNumber = LD.AimSeqNumber
			AND PSDMA.ProvSpecDelMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
			ON PSDMB.LearnRefNumber = LD.LearnRefNumber
			AND PSDMB.AimSeqNumber = LD.AimSeqNumber
			AND PSDMB.ProvSpecDelMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
			ON PSDMC.LearnRefNumber = LD.LearnRefNumber
			AND PSDMC.AimSeqNumber = LD.AimSeqNumber
			AND PSDMC.ProvSpecDelMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
			ON PSDMD.LearnRefNumber = LD.LearnRefNumber
			AND PSDMD.AimSeqNumber = LD.AimSeqNumber
			AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

    SET @SQLString += 
        N'
		--16-19
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
			--AND FM25.StartFund = 1

		--AEB and Apps (Legacy)
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
			--AND FM35.FundStart = 1

		--Apps (Reformed)
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		
		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
	'

	SET @SQLString += 
		N'
		LEFT JOIN (
			SELECT
				ALBV.LearnRefNumber,
				ALBV.AimSeqNumber,
				TotFundToPeriod = 
					CASE
						WHEN @ILRReturn = 1 THEN
							ALBV.Period_1
						WHEN @ILRReturn = 2 THEN
							ALBV.Period_1 + ALBV.Period_2
						WHEN @ILRReturn = 3 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3
						WHEN @ILRReturn = 4 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4
						WHEN @ILRReturn = 5 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5
						WHEN @ILRReturn = 6 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6
						WHEN @ILRReturn = 7 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7
						WHEN @ILRReturn = 8 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8
						WHEN @ILRReturn = 9 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9
						WHEN @ILRReturn = 10 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10
						WHEN @ILRReturn = 11 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11
						WHEN @ILRReturn = 12 THEN
							ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12
						ELSE 0
					END,
				TotFund6Mon = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6,
				TotFundYrEnd = ALBV.Period_1 + ALBV.Period_2 + ALBV.Period_3 + ALBV.Period_4 + ALBV.Period_5 + ALBV.Period_6 + ALBV.Period_7 + ALBV.Period_8 + ALBV.Period_9 + ALBV.Period_10 + ALBV.Period_11 + ALBV.Period_12,
				TotFundP01 = ALBV.Period_1,
				TotFundP02 = ALBV.Period_2,
				TotFundP03 = ALBV.Period_3,
				TotFundP04 = ALBV.Period_4,
				TotFundP05 = ALBV.Period_5,
				TotFundP06 = ALBV.Period_6,
				TotFundP07 = ALBV.Period_7,
				TotFundP08 = ALBV.Period_8,
				TotFundP09 = ALBV.Period_9,
				TotFundP10 = ALBV.Period_10,
				TotFundP11 = ALBV.Period_11,
				TotFundP12 = ALBV.Period_12
			FROM ' + @FISDatabase + '.dbo.Rulebase_ALB_LearningDelivery_PeriodisedValues ALBV
			WHERE
				ALBV.AttributeName = ''ALBSupportPayment''
		) ALBP
			ON ALBP.LearnRefNumber = LD.LearnRefNumber
			AND ALBP.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePay6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFund6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentYrEnd = SUM ( FM35P.OnProgPayment ),
				LearnSuppPaymentYrEnd = SUM ( FM35P.LearnSuppFundCash ),
				AchCompPaymentYrEnd = SUM ( FM35P.AchievePayment ),
				BalancePaymentYrEnd = SUM ( FM35P.BalancePayment ),
				EmpOutcomePayYrEnd = SUM ( FM35P.EmpOutcomePay ),
				TotFundYrEnd = SUM ( 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay 
				),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
	'
    
    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '
    
    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchCompPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END )
			FROM ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery_Period FM35P
			GROUP BY
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber
		) FM35P
			ON FM35P.LearnRefNumber = FM35.LearnRefNumber
			AND FM35P.AimSeqNumber = FM35.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM36PE.LearnRefNumber,
				AimSeqNumber = FM36PE.PriceEpisodeAimSeqNumber,
				FM36PE.EpisodeStartDate,
				FM36PE.PriceEpisodeTotalTNPPrice,
				FM36PE.PriceEpisodeCompletionElement,
				FM36PE.PriceEpisodeTotalPMRs,
				FM36PE.PriceEpisodeCumulativePMRs,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							FM36PE.LearnRefNumber,
							FM36PE.PriceEpisodeAimSeqNumber
						ORDER BY
							FM36PE.EpisodeStartDate DESC
					)
			FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_ApprenticeshipPriceEpisode FM36PE
				--AND FM36PE.EpisodeStartDate = FM36.AppAdjLearnStartDate
			WHERE
				FM36PE.EpisodeStartDate < ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
		) FM36PE
			ON FM36PE.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PE.AimSeqNumber = FM36.AimSeqNumber
			AND FM36PE.RowNum = 1
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber,
				FM36P.FundLineType,

				OnProgPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentToPeriod = 
					SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundToPeriod = 
					SUM (  CASE WHEN FM36P.Period <= @ILRReturn THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPayment6Mon = 
					SUM ( CASE WHEN FM36P.Period <= 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFund6Mon = 
					SUM (  CASE WHEN FM36P.Period <= 6 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentYrEnd = 
					SUM ( 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
					),
				LearnSuppPaymentYrEnd = 
					SUM ( 
						FM36P.LearnSuppFundCash 
					),
				AchCompPaymentYrEnd = 
					SUM ( 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
					),
				BalancePaymentYrEnd = 
					SUM ( 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
					),
				OtherPaymentYrEnd = 
					SUM ( 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
					),
				TotFundYrEnd = 
					SUM (  
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP01 = 
					SUM ( CASE WHEN FM36P.Period = 1 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP01 = 
					SUM (  CASE WHEN FM36P.Period = 1 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP02 = 
					SUM ( CASE WHEN FM36P.Period = 2 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP02 = 
					SUM (  CASE WHEN FM36P.Period = 2 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP03 = 
					SUM ( CASE WHEN FM36P.Period = 3 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP03 = 
					SUM (  CASE WHEN FM36P.Period = 3 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP04 = 
					SUM ( CASE WHEN FM36P.Period = 4 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP04 = 
					SUM (  CASE WHEN FM36P.Period = 4 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP05 = 
					SUM ( CASE WHEN FM36P.Period = 5 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP05 = 
					SUM (  CASE WHEN FM36P.Period = 5 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP06 = 
					SUM ( CASE WHEN FM36P.Period = 6 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP06 = 
					SUM (  CASE WHEN FM36P.Period = 6 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP07 = 
					SUM ( CASE WHEN FM36P.Period = 7 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP07 = 
					SUM (  CASE WHEN FM36P.Period = 7 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP08 = 
					SUM ( CASE WHEN FM36P.Period = 8 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP08 = 
					SUM (  CASE WHEN FM36P.Period = 8 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP09 = 
					SUM ( CASE WHEN FM36P.Period = 9 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP09 = 
					SUM (  CASE WHEN FM36P.Period = 9 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP10 = 
					SUM ( CASE WHEN FM36P.Period = 10 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP10 = 
					SUM (  CASE WHEN FM36P.Period = 10 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
	'

    SET @SQLString += 
		N'
				OnProgPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP11 = 
					SUM ( CASE WHEN FM36P.Period = 11 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP11 = 
					SUM (  CASE WHEN FM36P.Period = 11 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),

				OnProgPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						ELSE 0 END
					),
				LearnSuppPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnSuppFundCash 
						ELSE 0 END
					),
				AchCompPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END 
						ELSE 0 END
					),
				BalancePaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						ELSE 0 END
					),
				OtherPaymentP12 = 
					SUM ( CASE WHEN FM36P.Period = 12 THEN 
						FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					),
				TotFundP12 = 
					SUM (  CASE WHEN FM36P.Period = 12 THEN 
						CASE WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimOnProgPayment ELSE FM36P.ProgrammeAimProgFundIndMinCoInvest END 
						+ FM36P.MathEngOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment 
						+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment 
						+ FM36P.DisadvFirstPayment 
						+ FM36P.DisadvSecondPayment 
						+ FM36P.LearnDelFirstProv1618Pay 
						+ FM36P.LearnDelSecondProv1618Pay
						+ FM36P.LearnSuppFundCash
						+ CASE 
							WHEN FM36P.FundLineType LIKE ''16-18 Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.FundLineType LIKE ''19+ Apprenticeship%Non-Levy%'' THEN 0
							WHEN FM36P.LearnDelContType = ''Levy Contract'' THEN FM36P.ProgrammeAimCompletionPayment + FM36P.ProgrammeAimBalPayment
							ELSE 0 
						END
						+ FM36P.MathEngBalPayment 
						+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment 
						+ FM36P.LearnDelFirstEmp1618Pay 
						+ FM36P.LearnDelSecondEmp1618Pay
						ELSE 0 END
					)
			FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery_Period FM36P
			WHERE
				FM36P.FundLineType <> ''None''
			GROUP BY
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber,
				FM36P.FundLineType
		) FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
	'
    
    SET @SQLString += 
        N'
		--Invalid Learners
		LEFT JOIN (
			SELECT
				InvalidLearners = COUNT ( L.Learner_Id )
			FROM ' + @FISDatabase + '.dbo.Invalid_Learner L
		) INV
			ON 1 = 1

		LEFT JOIN #Frameworks FW
			ON FW.FrameworkCode = LD.FworkCode
		LEFT JOIN #PostCodes PC
			ON PC.PostCode = L.Postcode
	'
    
    SET @SQLString += 
        N'
		LEFT JOIN #LearningAims AIM
			ON AIM.AimCode = LD.LearnAimRef
		LEFT JOIN #CollegeStructure CS
			ON CS.AcademicYear = @AcademicYear
			AND CS.ProvSpecField =
				CASE
					WHEN @ProviderFieldCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END
		LEFT JOIN #CollegeStructure CSM
			ON CSM.AcademicYear = @AcademicYear
			AND CSM.ProvSpecField = MA.CourseCode
		LEFT JOIN (
			SELECT
				FacName = MIN ( CS.FacName )
			FROM #CollegeStructure CS
			WHERE
				CS.FacCode = @OverrideEngFac
		) FENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				FacName = MIN ( CS.FacName )
			FROM #CollegeStructure CS
			WHERE
				CS.FacCode = @OverrideMatFac
		) FMAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				FacName = MIN ( CS.FacName )
			FROM #CollegeStructure CS
			WHERE
				CS.FacCode = @OverridePartnerFac
		) FPAR
			ON 1 = 1
		LEFT JOIN (
			SELECT
				TeamName = MIN ( CS.TeamName )
			FROM #CollegeStructure CS
			WHERE
				CS.TeamCode = @OverrideEngTeam
		) TENG
			ON 1 = 1
		LEFT JOIN (
			SELECT
				TeamName = MIN ( CS.TeamName )
			FROM #CollegeStructure CS
			WHERE
				CS.TeamCode = @OverrideMatTeam
		) TMAT
			ON 1 = 1
		LEFT JOIN (
			SELECT
				TeamName = MIN ( CS.TeamName )
			FROM #CollegeStructure CS
			WHERE
				CS.TeamCode = @OverridePartnerTeam
		) TPAR
			ON 1 = 1
		LEFT JOIN #CourseHours CH
			ON CH.AcademicYear = @AcademicYear
			AND CH.ProvSpecField =
				CASE
					WHEN @ProviderFieldCourseLocation = ''A'' THEN
						PSDMA.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''B'' THEN
						PSDMB.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''C'' THEN
						PSDMC.ProvSpecDelMon
					WHEN @ProviderFieldCourseLocation = ''D'' THEN
						PSDMD.ProvSpecDelMon
				END
	'
    
    SET @SQLString += 
        N'
        LEFT JOIN ' + @FISOutputTableLocation + 'FIS_Providers PROV
			ON PROV.ProviderID = SRC.UKPRN
		LEFT JOIN ' + @FISOutputTableLocation + 'FIS_FacultyTitles FAC
            ON FAC.FacCode = 
                CASE
                    WHEN @ProviderFieldFacLocation = ''A'' THEN
                        PSDMA.ProvSpecDelMon
                    WHEN @ProviderFieldFacLocation = ''B'' THEN
                        PSDMB.ProvSpecDelMon
                    WHEN @ProviderFieldFacLocation = ''C'' THEN
                        PSDMC.ProvSpecDelMon
                    WHEN @ProviderFieldFacLocation = ''D'' THEN
                        PSDMD.ProvSpecDelMon
                    ELSE 
                        PSDMA.ProvSpecDelMon
                END
            AND FAC.AcademicYear = @AcademicYear
        LEFT JOIN ' + @FISOutputTableLocation + 'FIS_TeamTitles TEAM
            ON TEAM.TeamCode = 
                CASE
                    WHEN @ProviderFieldTeamLocation = ''A'' THEN
                        PSDMA.ProvSpecDelMon
                    WHEN @ProviderFieldTeamLocation = ''B'' THEN
                        PSDMB.ProvSpecDelMon
                    WHEN @ProviderFieldTeamLocation = ''C'' THEN
                        PSDMC.ProvSpecDelMon
                    WHEN @ProviderFieldTeamLocation = ''D'' THEN
                        PSDMD.ProvSpecDelMon
                    ELSE 
                        PSDMA.ProvSpecDelMon
                END
            AND TEAM.AcademicYear = @AcademicYear
	'

    SET @SQLString += 
        N'
		--FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PLH = COALESCE ( SUM ( CH.PLH ), 0 ),
				EEP = COALESCE ( SUM ( CH.EEP ), 0 ),
				OnProgPayment = 
					MAX ( FM25.OnProgPayment )
					- CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END,
				LearnSuppPayment = 
					CASE 
						WHEN @1619ALSFundingPercent > 0 THEN
							( MAX ( FM25.OnProgPayment ) / 100 ) * ( 0.07 * 100 )
						ELSE
							0
					END,
				TotFund = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN #CourseHours CH
				ON CH.AcademicYear = @AcademicYear
				AND CH.ProvSpecField =
					CASE
						WHEN @ProviderFieldCourseLocation = ''A'' THEN
							PSDMA.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''B'' THEN
							PSDMB.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''C'' THEN
							PSDMC.ProvSpecDelMon
						WHEN @ProviderFieldCourseLocation = ''D'' THEN
							PSDMD.ProvSpecDelMon
					END
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
				WHERE
					LD.FundModel = ''25''
					AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' --Exclude transfers
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			WHERE
				LD.FundModel = ''25''
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = L.LearnRefNumber
    '

    SET @SQLString += 
        N'
		LEFT JOIN #Employers EMPN
			ON EMPN.EmployerEDRS = LDR.LearnDel_EmpID
		LEFT JOIN #Partners PAR
			ON PAR.PartnerUKPRN = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END 
					

		--WHERE
			--L.LearnRefNumber = ''11024003''
	'
	
	--SELECT @SQLString AS [processing-instruction(x)] FOR XML PATH('')

	SET @SQLParams = 
        N'@AcademicYear NVARCHAR(5),
    	@ILRReturn INT,
    	@IsFinalReturn BIT,
    	@Split1619Funding BIT,
		@1619ALSFundingPercent DECIMAL(3,2),
		@IncludeHEAdvLoanPossIncome BIT,
		@IncludeAdvLoanBursaryIncome BIT,
		@AEBCombinedAuthorityName NVARCHAR(200),
    	@FutureAchieveWeighting DECIMAL(3,2),
        @FISOutputTableLocation NVARCHAR(200),
    	@ProviderFieldFacLocation CHAR(1),
		@ProviderFieldTeamLocation CHAR(1),
		@ProviderFieldCostCentreLocation CHAR(1),
		@ProviderFieldCourseLocation CHAR(1),
    	@OverrideEngFac NVARCHAR(50),
    	@OverrideMatFac NVARCHAR(50),
    	@OverrideEngTeam NVARCHAR(50),
    	@OverrideMatTeam NVARCHAR(50),
    	@OverrideEngCostCentre NVARCHAR(50),
    	@OverrideMatCostCentre NVARCHAR(50),
    	@OverridePartnerFac NVARCHAR(50),
    	@OverridePartnerTeam NVARCHAR(50),
    	@OverridePartnerCostCentre NVARCHAR(50)';
    
    EXECUTE sp_executesql 
        @SQLString, 
        @SQLParams, 
        @AcademicYear = @AcademicYear,
    	@ILRReturn = @ILRReturn,
    	@IsFinalReturn = @IsFinalReturn,
    	@Split1619Funding = @Split1619Funding,
		@1619ALSFundingPercent = @1619ALSFundingPercent,
		@IncludeHEAdvLoanPossIncome = @IncludeHEAdvLoanPossIncome,
		@IncludeAdvLoanBursaryIncome = @IncludeAdvLoanBursaryIncome,
		@AEBCombinedAuthorityName = @AEBCombinedAuthorityName,
    	@FutureAchieveWeighting = @FutureAchieveWeighting,
        @FISOutputTableLocation = @FISOutputTableLocation,
    	@ProviderFieldFacLocation = @ProviderFieldFacLocation,
		@ProviderFieldTeamLocation = @ProviderFieldTeamLocation,
		@ProviderFieldCostCentreLocation = @ProviderFieldCostCentreLocation,
		@ProviderFieldCourseLocation = @ProviderFieldCourseLocation,
    	@OverrideEngFac = @OverrideEngFac,
    	@OverrideMatFac = @OverrideMatFac,
    	@OverrideEngTeam = @OverrideEngTeam,
    	@OverrideMatTeam = @OverrideMatTeam,
    	@OverrideEngCostCentre = @OverrideEngCostCentre,
    	@OverrideMatCostCentre = @OverrideMatCostCentre,
    	@OverridePartnerFac = @OverridePartnerFac,
    	@OverridePartnerTeam = @OverridePartnerTeam,
    	@OverridePartnerCostCentre = @OverridePartnerCostCentre;
END