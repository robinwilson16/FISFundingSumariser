ALTER PROCEDURE SPR_FIS_GenerateFundingData
	@FISDatabase VARCHAR(50),
	@AcademicYear VARCHAR(5),
	@ILRReturn VARCHAR(2),
	@IsFinalReturn bit,
	@Split1619Funding bit,
	@FutureAchieveWeighting DECIMAL(3,2),
	@Mode CHAR(1),
	@FISOutputTable VARCHAR(200),
	@ProSolutionDatabaseLocation VARCHAR(200),
	@ProAchieveDatabaseLocation VARCHAR(200),
	@ProviderFieldCourseLocation CHAR(1),
	@ProviderFieldCourseFormat VARCHAR(50),
	@OverrideEngFac VARCHAR(50),
	@OverrideMatFac VARCHAR(50),
	@OverrideEngTeam VARCHAR(50),
	@OverrideMatTeam VARCHAR(50),
	@OverrideEngCostCentre VARCHAR(50),
	@OverrideMatCostCentre VARCHAR(50),
	@OverridePartnerFac VARCHAR(50),
	@OverridePartnerTeam VARCHAR(50),
	@OverridePartnerCostCentre VARCHAR(50)
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @TableExists bit = 1;
	DECLARE @NumExistingRecords int = 0;
	DECLARE @SQL NVARCHAR(MAX);

	IF @Mode = 'R'
		IF OBJECT_ID('dbo.FIS_FundingData', 'U') IS NOT NULL 
			BEGIN
				SET @SQL = 
					'DROP TABLE dbo.FIS_FundingData'

				EXEC(@SQL)
			END
	ELSE
		IF OBJECT_ID('dbo.FIS_FundingData', 'U') IS NULL 
			SET @TableExists = 0;

	IF @Mode = 'R' OR @TableExists = 0
		BEGIN
			SET @SQL = 
				'CREATE TABLE ' + @FISOutputTable + 'FIS_FundingData (
					AcademicYear varchar(5) NULL,
					ILRReturn varchar(3) NULL,
					IsFinalReturn int NULL,
					ILRReturnDate datetime2 NULL,
					SQLDatabase varchar(50) NULL,
					Is1619FundingSplit int NULL,
					InvalidLearners int NULL,

					LearnerRef nvarchar(12) NULL,
					Surname nvarchar(100) NULL,
					Forename nvarchar(100) NULL,
					DOB datetime2 NULL,
					AgeSept float NULL,
					Address1 varchar(150) NULL,
					Address2 varchar(150) NULL,
					Address3 varchar(150) NULL,
					Address4 varchar(150) NULL,
					PostCode varchar(10) NULL,
					Tel varchar(50) NULL,
					Email varchar(150) NULL,
					PostCodeWardCode varchar(50) NULL,
					PostCodeWardName varchar(50) NULL,
					PostCodeDistrictCode varchar(50) NULL,
					PostCodeDistrictName varchar(50) NULL,
					PostCodeLEACode varchar(50) NULL,
					PostCodeLEAName varchar(50) NULL,
					PostCode1619Uplift float NULL,
					PostCodeAdultUplift float NULL,
					PostCodeAppUplift float NULL,
					PostCodeUpliftApplied float NULL,
					EmpStatusCode int NULL,
					EmpStatusName varchar(20) NULL,
					EmpStatusAppliesDate datetime2 NULL,
					EmpStatusEmployerID int NULL,
					LengthOfEmploy int NULL,
					LengthOfUnemploy int NULL,
					BenefitStatusInd int NULL,
					SmallEmployer int NULL,
					SelfEmployInd int NULL,
					EmployIntensityInd int NULL,
					IsFirstFullLevel2 int NULL,
					IsFirstFullLevel3 int NULL,

					FundLine nvarchar(100) NULL,
					FundLineSummary nvarchar(100) NULL,
					FundModel float NULL,
					SortOrder int NULL,
					IsFunded int NULL,
					IsAdvLearnLoan int NULL,
					RateBand nvarchar(50) NULL,
					CofEnglish varchar(100) NULL,
					CofMaths varchar(100) NULL,
					CofEnglishMet int NULL,
					CofMathsMet int NULL,
					CofMet int NULL,

					CampusID varchar(20) NULL,
					SiteCode varchar(20) NULL,
					SiteName varchar(100) NULL,
					FacCode varchar(20) NULL,
					FacName varchar(150) NULL,
					MainFacCode varchar(20) NULL,
					MainFacName varchar(150) NULL,
					TeamCode varchar(20) NULL,
					TeamName varchar(150) NULL,
					CostCentre varchar(20) NULL,
					FacCodeOrig varchar(20) NULL,
					FacNameOrig varchar(150) NULL,
					TeamCodeOrig varchar(20) NULL,
					TeamNameOrig varchar(150) NULL,
					CostCentreOrig varchar(20) NULL,
					SSA1Code varchar(5) NULL,
					SSA1Title varchar(255) NULL,
					SSA2Code varchar(5) NULL,
					SSA2Title varchar(255) NULL,
					CourseCode varchar(20) NULL,
					CourseTitle varchar(255) NULL,
					GroupCode varchar(20) NULL,

					AimSequence int NULL,
					AimType float NULL,
					AimCode varchar(8) NULL,
					AimTitle varchar(150) NULL,
					StartDate datetime2 NULL,
					ExpEndDate datetime2 NULL,
					ActEndDate datetime2 NULL,
					LearnerPLH float NULL,
					LearnerEEP float NULL,
					FM25PLHAim float NULL,
					FM25EEPAim float NULL,
					FM25PLHAllAims float NULL,
					FM25EEPAllAims float NULL,

					CompletionCode float NULL,
					CompletionDesc varchar(20) NULL,
					OutcomeCode float NULL,
					OutcomeDesc varchar(20) NULL,
					WithdrawReason varchar(2) NULL,
					Grade nvarchar(6) NULL,
					AwardBody varchar(20) NULL,

					FrameworkCode float NULL,
					FrameworkName varchar(150) NULL,
					EmployerID int NULL,
					EmployerName varchar(100) NULL,
					PartnerCode float NULL,
					PartnerName varchar(100) NULL,
					
					ProgWeightFactor char(1) NULL,
					UnweightFundRate float NULL,
					WeightFundRate float NULL,
					NVQLevel char(1) NULL,
					CoFundingIndicator varchar(10) NULL,
					IsCarryIn int NULL,
					EnrolmentID varchar(20) NULL,
					FM25TotFund float NULL,

					OnProgPaymentToPeriod float NULL,
					LearnSuppPaymentToPeriod float NULL,
					AchCompPaymentToPeriod float NULL,
					BalancePaymentToPeriod float NULL,
					EmpOutcomePayToPeriod float NULL,
					OtherPaymentToPeriod float NULL,
					TotFundToPeriod float NULL,

					OnProgPayment6Mon float NULL,
					LearnSuppPayment6Mon float NULL,
					AchCompPayment6Mon float NULL,
					BalancePayment6Mon float NULL,
					EmpOutcomePay6Mon float NULL,
					OtherPayment6Mon float NULL,
					TotFund6Mon float NULL,

					OnProgPaymentYrEnd float NULL,
					LearnSuppPaymentYrEnd float NULL,
					AchCompPaymentYrEnd float NULL,
					BalancePaymentYrEnd float NULL,
					EmpOutcomePayYrEnd float NULL,
					OtherPaymentYrEnd float NULL,
					TotFundYrEnd float NULL,

					FutureAchievePayment float NULL,
					FutureAchieveWeighting decimal(3, 2) NULL,
					FutureAchievePaymentWeighted float NULL,

					EmployerContibutionPMRTot float NULL,
					EmployerContibutionPMRCum float NULL,

					OnProgPaymentP01 float NULL,
					LearnSuppPaymentP01 float NULL,
					AchCompPaymentP01 float NULL,
					BalancePaymentP01 float NULL,
					EmpOutcomePayP01 float NULL,
					OtherPaymentP01 float NULL,
					TotFundP01 float NULL,

					OnProgPaymentP02 float NULL,
					LearnSuppPaymentP02 float NULL,
					AchCompPaymentP02 float NULL,
					BalancePaymentP02 float NULL,
					EmpOutcomePayP02 float NULL,
					OtherPaymentP02 float NULL,
					TotFundP02 float NULL,

					OnProgPaymentP03 float NULL,
					LearnSuppPaymentP03 float NULL,
					AchCompPaymentP03 float NULL,
					BalancePaymentP03 float NULL,
					EmpOutcomePayP03 float NULL,
					OtherPaymentP03 float NULL,
					TotFundP03 float NULL,

					OnProgPaymentP04 float NULL,
					LearnSuppPaymentP04 float NULL,
					AchCompPaymentP04 float NULL,
					BalancePaymentP04 float NULL,
					EmpOutcomePayP04 float NULL,
					OtherPaymentP04 float NULL,
					TotFundP04 float NULL,

					OnProgPaymentP05 float NULL,
					LearnSuppPaymentP05 float NULL,
					AchCompPaymentP05 float NULL,
					BalancePaymentP05 float NULL,
					EmpOutcomePayP05 float NULL,
					OtherPaymentP05 float NULL,
					TotFundP05 float NULL,

					OnProgPaymentP06 float NULL,
					LearnSuppPaymentP06 float NULL,
					AchCompPaymentP06 float NULL,
					BalancePaymentP06 float NULL,
					EmpOutcomePayP06 float NULL,
					OtherPaymentP06 float NULL,
					TotFundP06 float NULL,

					OnProgPaymentP07 float NULL,
					LearnSuppPaymentP07 float NULL,
					AchCompPaymentP07 float NULL,
					BalancePaymentP07 float NULL,
					EmpOutcomePayP07 float NULL,
					OtherPaymentP07 float NULL,
					TotFundP07 float NULL,

					OnProgPaymentP08 float NULL,
					LearnSuppPaymentP08 float NULL,
					AchCompPaymentP08 float NULL,
					BalancePaymentP08 float NULL,
					EmpOutcomePayP08 float NULL,
					OtherPaymentP08 float NULL,
					TotFundP08 float NULL,

					OnProgPaymentP09 float NULL,
					LearnSuppPaymentP09 float NULL,
					AchCompPaymentP09 float NULL,
					BalancePaymentP09 float NULL,
					EmpOutcomePayP09 float NULL,
					OtherPaymentP09 float NULL,
					TotFundP09 float NULL,

					OnProgPaymentP10 float NULL,
					LearnSuppPaymentP10 float NULL,
					AchCompPaymentP10 float NULL,
					BalancePaymentP10 float NULL,
					EmpOutcomePayP10 float NULL,
					OtherPaymentP10 float NULL,
					TotFundP10 float NULL,

					OnProgPaymentP11 float NULL,
					LearnSuppPaymentP11 float NULL,
					AchCompPaymentP11 float NULL,
					BalancePaymentP11 float NULL,
					EmpOutcomePayP11 float NULL,
					OtherPaymentP11 float NULL,
					TotFundP11 float NULL,

					OnProgPaymentP12 float NULL,
					LearnSuppPaymentP12 float NULL,
					AchCompPaymentP12 float NULL,
					BalancePaymentP12 float NULL,
					EmpOutcomePayP12 float NULL,
					OtherPaymentP12 float NULL,
					TotFundP12 float NULL
				)'

			EXEC(@SQL)

			SET @SQL = 
				'CREATE CLUSTERED INDEX CX_FIS_FundingData ON ' + @FISOutputTable + 'FIS_FundingData ( AcademicYear, ILRReturn, ILRReturnDate )'

			EXEC(@SQL)
		END
	ELSE
		BEGIN
			SET @SQL = '
				SELECT
					@NumExistingRecords = SUM ( 1 )
				FROM ' + @FISOutputTable + 'FIS_FundingData FD
				WHERE
					FD.AcademicYear = ''' + @AcademicYear + '''
					AND FD.SQLDatabase = ''' + @FISDatabase + ''''

			EXEC sp_executesql @SQL, N'@NumExistingRecords int out', @NumExistingRecords out
			
			IF @NumExistingRecords > 0
				BEGIN
					SET @SQL = '
						DELETE FROM ' + @FISOutputTable + 'FIS_FundingData
						WHERE
							FD.AcademicYear = ''' + @AcademicYear + '''
							AND FD.SQLDatabase = ''' + @FISDatabase + ''''

					EXEC(@SQL)
				END
		END

	SET @SQL = '
		INSERT INTO ' + @FISOutputTable + 'FIS_FundingData
		EXEC SPR_FIS_FundingData_' + REPLACE ( @AcademicYear, '/', '' ) + '
			''' + @FISDatabase + ''', 
			''' + @AcademicYear + ''', 
			''' + CAST ( @ILRReturn AS VARCHAR(2) ) + ''', 
			''' + CAST ( @IsFinalReturn AS CHAR(1) ) + ''', 
			''' + CAST ( @Split1619Funding AS CHAR(1) ) + ''', 
			''' + CAST ( @FutureAchieveWeighting AS VARCHAR(5) ) + ''', 
			''' + @ProSolutionDatabaseLocation + ''', 
			''' + @ProAchieveDatabaseLocation + ''',
			''' + @ProviderFieldCourseLocation + ''',
			''' + @ProviderFieldCourseFormat + ''',
			''' + @OverrideEngFac + ''',
			''' + @OverrideMatFac + ''',
			''' + @OverrideEngTeam + ''',
			''' + @OverrideMatTeam + ''',
			''' + @OverrideEngCostCentre + ''',
			''' + @OverrideMatCostCentre + ''',
			''' + @OverridePartnerFac + ''',
			''' + @OverridePartnerTeam + ''',
			''' + @OverridePartnerCostCentre + ''''

	EXEC(@SQL)
END