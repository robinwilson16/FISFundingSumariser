ALTER PROCEDURE SPR_FIS_FundingData_1718
	@FISDatabase NVARCHAR(50),
	@AcademicYear NVARCHAR(5),
	@ILRReturn NVARCHAR(2),
	@IsFinalReturn bit,
	@Split1619Funding bit,
	@FutureAchieveWeighting DECIMAL(3,2),
	@ProSolutionDatabaseLocation NVARCHAR(200),
	@ProAchieveDatabaseLocation NVARCHAR(200),
	@ProviderFieldCourseLocation CHAR(1),
	@ProviderFieldCourseFormat NVARCHAR(50),
	@OverrideEngFac NVARCHAR(50),
	@OverrideMatFac NVARCHAR(50),
	@OverrideEngTeam NVARCHAR(50),
	@OverrideMatTeam NVARCHAR(50),
	@OverrideEngCostCentre NVARCHAR(50),
	@OverrideMatCostCentre NVARCHAR(50),
	@OverridePartnerFac NVARCHAR(50),
	@OverridePartnerTeam NVARCHAR(50),
	@OverridePartnerCostCentre NVARCHAR(50)
AS
BEGIN
	SET NOCOUNT ON;

	-- DECLARE @FISDatabase NVARCHAR(50) = 'FIS_1819_R05_F'
	-- DECLARE @AcademicYear NVARCHAR(5) = '17/18'
	-- DECLARE @ILRReturn NVARCHAR(2) = '5'
	-- DECLARE @IsFinalReturn BIT = 1
	-- DECLARE @Split1619Funding BIT = 1
	-- DECLARE @FutureAchieveWeighting DECIMAL(3,2) = 0.75
	-- DECLARE @ProSolutionDatabaseLocation NVARCHAR(200) = 'ProSolution.dbo.'
	-- DECLARE @ProAchieveDatabaseLocation NVARCHAR(200) = 'ussql01.ProGeneral.dbo.'
	-- DECLARE @ProviderFieldCourseLocation CHAR(1) = 'A'
	-- DECLARE @ProviderFieldCourseFormat NVARCHAR(50) = 'CRS.Code + "-" + GRP.Code'
	-- DECLARE @OverrideEngFac NVARCHAR(50) = 'F05'
	-- DECLARE @OverrideMatFac NVARCHAR(50) = 'F05'
	-- DECLARE @OverrideEngTeam NVARCHAR(50) = 'T01'
	-- DECLARE @OverrideMatTeam NVARCHAR(50) = 'T02'
	-- DECLARE @OverrideEngCostCentre NVARCHAR(50) = '4461'
	-- DECLARE @OverrideMatCostCentre NVARCHAR(50) = '4462'
	-- DECLARE @OverridePartnerFac NVARCHAR(50) = 'F00'
	-- DECLARE @OverridePartnerTeam NVARCHAR(50) = 'T00'
	-- DECLARE @OverridePartnerCostCentre NVARCHAR(50) = ''

	DECLARE @SQLString NVARCHAR(MAX);
    DECLARE @SQLParams NVARCHAR(MAX);

	SET @ProviderFieldCourseFormat = REPLACE ( @ProviderFieldCourseFormat, '"', '''' )

	SET @SQLString = 
        N'
		SELECT
			AcademicYear = @AcademicYear,
			ILRReturn = 
				CASE
					WHEN LEN ( @ILRReturn ) = 1 THEN ''R0'' + @ILRReturn
					ELSE ''R'' + @ILRReturn
				END,
			IsFinalReturn = @IsFinalReturn,
			ILRReturnDate = SRC.DateTime,
			SQLDatabase = ''' + @FISDatabase + ''',
			Is1619FundingSplit = CASE WHEN LD.FundModel = ''25'' AND @Split1619Funding = 1 AND COALESCE ( HRS.PLH, 0 ) > 0 THEN 1 ELSE 0 END,
			InvalidLearners = INV.InvalidLearners,

			LearnerRef = L.LearnRefNumber,
			Surname = L.FamilyName,
			Forename = L.GivenNames,
			DOB = L.DateOfBirth,
			AgeSept = DV.Learn_Age31Aug,
			Address1 = L.AddLine1,
			Address2 = L.AddLine2,
			Address3 = L.AddLine3,
			Address4 = L.AddLine4,
			PostCode = L.Postcode,
			Tel = L.TelNo,
			Email = L.Email,
			PostCodeWardCode = PCW.WardCode,
			PostCodeWardName = PCW.WardName,
			PostCodeDistrictCode = PCW.DistrictCode,
			PostCodeDistrictName = PCW.DistrictName,
			PostCodeLEACode = PCW.LEACode,
			PostCodeLEAName = PCW.LEAName,
			PostCode1619Uplift = COALESCE ( PCU.EFA_UPLIFT, 1 ),
			PostCodeAdultUplift = COALESCE ( PCU.SFA_UPLIFT, 1 ),
			PostCodeAppUplift = COALESCE ( PCU.APP_FUNDING_UPLIFT, 1 ),
			PostCodeUpliftApplied =
				CASE
					WHEN LD.FundModel = ''25'' THEN COALESCE ( PCU.EFA_UPLIFT, 1 )
					WHEN LD.FundModel = ''35'' AND LD.FworkCode IS NULL THEN COALESCE ( PCU.SFA_UPLIFT, 1 )
					WHEN LD.FundModel = ''35'' AND LD.FworkCode IS NOT NULL THEN COALESCE ( PCU.APP_FUNDING_UPLIFT, 1 )
					WHEN LD.FundModel = ''36'' THEN COALESCE ( PCU.APP_FUNDING_UPLIFT, 1 )
					ELSE 1
				END,
			EmpStatusCode = EMP.EmpStatusCode,
			EmpStatusName = EMP.EmpStatusName,
			EmpStatusAppliesDate = EMP.EmpStatusAppliesDate,
			EmpStatusEmployerID = EMP.EmployerID,
			LengthOfEmploy = ESM.LOE,
			LengthOfUnemploy = ESM.LOU,
			BenefitStatusInd = ESM.BSI,
			SmallEmployer = ESM.SEM,
			SelfEmployInd = ESM.SEI,
			EmployIntensityInd = ESM.EII,
			IsFirstFullLevel2 = DV.Learn_FirstFullLevel2,
			IsFirstFullLevel3 = DV.Learn_FirstFullLevel3,

			FundLine = 
				COALESCE ( 
					CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
					FM25.FundLine, 
					CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
					AEC.LearnDelInitialFundLineType,
					FM35.FundLine,
					CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
					CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
				),
    '

    SET @SQLString += 
        N'
			FundLineSummary =
				CASE
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) IN (
							''16-19 Students (excluding High Needs Students)'',
							 ''16-19 High Needs Students'',
							 ''19-24 Students with an EHCP'',
							 ''19+ Continuing Students (excluding EHCP)''
						)
							 THEN ''16-19 Students (inc. High Needs)''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship (Legacy)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''16-18 Apprenticeship (Reformed) Non-Levy''
					
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''16-18 Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''16-18 Apprenticeship (Reformed) Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship (Legacy)''

					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Non-Levy%''
							 THEN ''19+ Apprenticeship (Reformed) Non-Levy''
	'

    SET @SQLString += 
        N'
					WHEN 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''19% Apprenticeship%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) NOT LIKE ''%Non-Levy%''
						AND COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						) LIKE ''%Levy%''
							 THEN ''19+ Apprenticeship (Reformed) Levy''

					ELSE 
						COALESCE ( 
							CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
							FM25.FundLine, 
							CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
							AEC.LearnDelInitialFundLineType,
							FM35.FundLine,
							CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
							CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
						)
				END,
			FundModel = LD.FundModel,
			SortOrder =
				CASE
					COALESCE ( 
						CASE WHEN LD.FundModel = ''25'' THEN HRS.FundLine END,
						FM25.FundLine, 
						CASE WHEN ALB.AdvLoan = 1 AND ALB.FundLine = ''None'' THEN ''Advanced Learner Loan (ALL)'' END,
						AEC.LearnDelInitialFundLineType,
						FM35.FundLine,
						CASE WHEN HE.LearnRefNumber IS NOT NULL THEN ''Higher Education'' END,
						CASE WHEN LD.FundModel = ''99'' THEN ''Full Cost'' END 
					)
					WHEN ''16-19 Students (excluding High Needs Students)'' THEN 1
					WHEN ''16-19 High Needs Students'' THEN 2
					WHEN ''19-24 Students with an EHCP'' THEN 3
					WHEN ''Advanced Learner Loan (ALL)'' THEN 4
					WHEN ''Advanced Learner Loans Bursary'' THEN 5
					WHEN ''19+ Continuing Students (excluding EHCP)'' THEN 6
					WHEN ''AEB - Other Learning (non-procured)'' THEN 7
					WHEN ''Higher Education'' THEN 8
					WHEN ''Full Cost'' THEN 9
					ELSE 99
				END,
	'

    SET @SQLString += 
        N'
			IsFunded = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN HRS.IsFunded END, FM25.StartFund, ALB.FundStart, FM35.FundStart, FM36.FundStart, 0 ),
			IsAdvLearnLoan = ALB.AdvLoan,
			RateBand = HRS.RateBand,
			CofEnglish = FM25.ConditionOfFundingEnglish,
			CofMaths = FM25.ConditionOfFundingMaths,
			CofEnglishMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' THEN 0
					ELSE 1
				END,
			CofMathsMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths'' THEN 0
					ELSE 1
				END,
			CofMet = 
				CASE
					WHEN FM25.LearnRefNumber IS NULL THEN NULL
					WHEN 
						FM25.ConditionOfFundingEnglish = ''Doesn''''t have English, Not Studying English'' 
						OR FM25.ConditionOfFundingMaths = ''Doesn''''t have Maths, Not Studying Maths''
						THEN 0
					ELSE 1
				END,

			CampusID = NULL,
			SiteCode = COALESCE ( PROS.SiteCode, ''-'' ),
			SiteName = COALESCE ( PROS.SiteName, ''-- Unknown --'' ),
			FacCode = 
				CASE
					WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN COALESCE ( PROS.FacCodePartner, ''-'' )
					ELSE COALESCE ( PROS.FacCode, ''-'' )
				END,
			FacName = 
				CASE
					WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN COALESCE ( PROS.FacNamePartner, ''-- Unknown --'' )
					ELSE COALESCE ( PROS.FacName, ''-- Unknown --'' )
				END,
			MainFacCode = COALESCE ( PROSM.FacCode, ''-'' ),
			MainFacName = COALESCE ( PROSM.FacName, ''-- Unknown --'' ),
			TeamCode = 
				CASE
					WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN COALESCE ( PROS.TeamCodePartner, ''-'' )
					ELSE COALESCE ( PROS.TeamCode, ''-'' )
				END,
			TeamName = 
				CASE
					WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN COALESCE ( PROS.TeamNamePartner, ''-- Unknown --'' )
					ELSE COALESCE ( PROS.TeamName, ''-- Unknown --'' )
				END,
			CostCentre = 
				CASE
					WHEN LD.PartnerUKPRN IS NOT NULL AND LD.FundModel IN ( ''25'', ''35'' ) THEN PROS.CostCentrePartner
					ELSE PROS.CostCentre
				END,
			FacCodeOrig = PROS.FacCodeOrig,
			FacNameOrig = PROS.FacNameOrig,
			TeamCodeOrig = PROS.TeamCodeOrig,
			TeamNameOrig = PROS.TeamNameOrig,
			CostCentreOrig = PROS.CostCentreOrig,
			SSA1Code = AIM.SSA1ID,
			SSA1Title = SSA1.SSA_Tier1_Desc,
			SSA2Code = AIM.SSA2ID,
			SSA2Title = SSA2.SSA_Tier2_Desc,
			CourseCode = PSDMA.ProvSpecDelMon,
			CourseTitle = PROS.CourseTitle,
			GroupCode = PSDMB.ProvSpecDelMon,

			AimSequence = LD.AimSeqNumber,
			AimType = LD.AimType,
			AimCode = LD.LearnAimRef,
			AimTitle = AIM.LEARNING_AIM_TITLE,
			StartDate = LD.LearnStartDate,
			ExpEndDate = LD.LearnPlanEndDate,
			ActEndDate = LD.LearnActEndDate,
			LearnerPLH = COALESCE ( L.PlanLearnHours, 0 ),
			LearnerEEP = COALESCE ( L.PlanEEPHours, 0 ),
			FM25PLHAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN PROS.PLH END, 0 ),
			FM25EEPAim = COALESCE ( CASE WHEN LD.FundModel = ''25'' AND ( COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 ) THEN PROS.EEP END, 0 ),
			FM25PLHAllAims = COALESCE ( HRS.PLH, 0 ),
			FM25EEPAllAims = COALESCE ( HRS.EEP, 0 ),
    '

    SET @SQLString += 
        N'
			CompletionCode = LD.CompStatus,
			CompletionDesc = 
				CASE
					WHEN LD.CompStatus = ''1'' THEN ''Cont''
					WHEN LD.CompStatus = ''2'' THEN ''Comp''
					WHEN LD.CompStatus = ''3'' THEN ''Wdr''
					WHEN LD.CompStatus = ''6'' THEN ''Brk''
					ELSE ''X''
				END,
			OutcomeCode = LD.Outcome,
			OutcomeDesc = 
				CASE
					WHEN LD.Outcome IS NULL THEN NULL
					WHEN LD.Outcome = ''1'' THEN ''Ach''
					WHEN LD.Outcome = ''2'' THEN ''Partial''
					WHEN LD.Outcome = ''3'' THEN ''Fail''
					WHEN LD.Outcome = ''8'' THEN ''Unknown''
					ELSE ''X''
				END,
			WithdrawReason = LD.WithdrawReason,
			Grade = LD.OutGrade,
			AwardBody = AIM.AWARDING_BODY_CODE,

			FrameworkCode = LD.FworkCode,
			FrameworkName = COALESCE ( FW.Framework_Desc, ''-- Unknown --'' ),
			EmployerID = 
				CASE
					WHEN LDR.LearnDel_EmpID = -1 THEN NULL
					ELSE LDR.LearnDel_EmpID
				END,
			EmployerName = EMPN.Name,
			PartnerCode = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END,
			PartnerName = PTN.Name,

			ProgWeightFactor = FM35.ApplicProgWeightFact,
			UnweightFundRate = FM35.ApplicUnweightFundRate,
			WeightFundRate = FM35.ApplicWeightFundRate,
			NVQLevel = AIM.NOTIONAL_NVQ_LEVEL_CODE,
			CoFundingIndicator = 
				CASE
					WHEN FFI.LearnDelFAMCode IS NULL THEN NULL
					WHEN FFI.LearnDelFAMCode = ''1'' THEN ''Full''
					WHEN FFI.LearnDelFAMCode = ''2'' THEN ''Co''
					ELSE NULL
				END,
			IsCarryIn = 
				CASE
					WHEN CAST ( LD.LearnStartDate AS DATE ) <= ''20'' + LEFT ( @AcademicYear, 2) + ''-08-01'' THEN 1
					ELSE 0
				END,
			EnrolmentID = PSDMC.ProvSpecDelMon,
			FM25TotFund = COALESCE ( HRS.Funding, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * @ILRReturn END, FM35P.OnProgPaymentToPeriod, FM36P.OnProgPaymentToPeriod, ( HE.GROSSFEE / 12 ) * @ILRReturn, 0 ),
			LearnSuppPaymentToPeriod = COALESCE ( FM35P.LearnSuppPaymentToPeriod, FM36P.LearnSuppPaymentToPeriod, 0 ),
			AchCompPaymentToPeriod = COALESCE ( FM35P.AchievePaymentToPeriod, FM36P.CompletionPaymentToPeriod, 0 ),
			BalancePaymentToPeriod = COALESCE ( FM35P.BalancePaymentToPeriod, FM36P.BalancePaymentToPeriod, 0 ),
			EmpOutcomePayToPeriod = COALESCE ( FM35P.EmpOutcomePayToPeriod, 0 ),
			OtherPaymentToPeriod = COALESCE ( FM36P.OtherPaymentToPeriod, 0 ),
			TotFundToPeriod = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * @ILRReturn END, FM35P.TotFundToPeriod, FM36P.TotFundToPeriod, ( HE.GROSSFEE / 12 ) * @ILRReturn, 0 ),

			OnProgPayment6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * 6 END, FM35P.OnProgPayment6Mon, FM36P.OnProgPayment6Mon, ( HE.GROSSFEE / 12 ) * 6, 0 ),
			LearnSuppPayment6Mon = COALESCE ( FM35P.LearnSuppPayment6Mon, FM36P.LearnSuppPayment6Mon, 0 ),
			AchCompPayment6Mon = COALESCE ( FM35P.AchievePayment6Mon, FM36P.CompletionPayment6Mon, 0 ),
			BalancePayment6Mon = COALESCE ( FM35P.BalancePayment6Mon, FM36P.BalancePayment6Mon, 0 ),
			EmpOutcomePay6Mon = COALESCE ( FM35P.EmpOutcomePay6Mon, 0 ),
			OtherPayment6Mon = COALESCE ( FM36P.OtherPayment6Mon, 0 ),
			TotFund6Mon = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) * 6 END, FM35P.TotFund6Mon, FM36P.TotFund6Mon, ( HE.GROSSFEE / 12 ) * 6, 0 ),
    '

    SET @SQLString += 
        N'
			OnProgPaymentYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END END, FM35P.OnProgPaymentYrEnd, FM36P.OnProgPaymentYrEnd, HE.GROSSFEE, 0 ),
			LearnSuppPaymentYrEnd = COALESCE ( FM35P.LearnSuppPaymentYrEnd, FM36P.LearnSuppPaymentYrEnd, 0 ),
			AchCompPaymentYrEnd = COALESCE ( FM35P.AchievePaymentYrEnd, FM36P.CompletionPaymentYrEnd, 0 ),
			BalancePaymentYrEnd = COALESCE ( FM35P.BalancePaymentYrEnd, FM36P.BalancePaymentYrEnd, 0 ),
			EmpOutcomePayYrEnd = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentYrEnd = COALESCE ( FM36P.OtherPaymentYrEnd, 0 ),
			TotFundYrEnd = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END END, FM35P.TotFundYrEnd, FM36P.TotFundYrEnd, HE.GROSSFEE, 0 ),

			FutureAchievePayment = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchievePaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.CompletionPaymentYrEnd )
				END,
			FutureAchieveWeighting = @FutureAchieveWeighting,
			FutureAchievePaymentWeighted = 
				CASE
					WHEN LD.CompStatus <> 1 AND NOT ( LD.CompStatus = 2 AND LD.Outcome = 8 ) THEN 0
					WHEN LD.LearnPlanEndDate NOT BETWEEN ''20'' + LEFT ( @AcademicYear, 2 ) + ''-08-01'' AND ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-07-31'' THEN 0
					ELSE COALESCE ( FM35.AchieveElement - FM35P.AchievePaymentYrEnd, FM36PE.PriceEpisodeCompletionElement - FM36P.CompletionPaymentYrEnd ) * @FutureAchieveWeighting
				END,

			EmployerContibutionPMRTot = COALESCE ( FM36PE.PriceEpisodeTotalPMRs, 0 ),
			EmployerContibutionPMRCum = COALESCE ( FM36PE.PriceEpisodeCumulativePMRs, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP01, FM36P.OnProgPaymentP01, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP01 = COALESCE ( FM35P.LearnSuppPaymentP01, FM36P.LearnSuppPaymentP01, 0 ),
			AchCompPaymentP01 = COALESCE ( FM35P.AchievePaymentP01, FM36P.CompletionPaymentP01, 0 ),
			BalancePaymentP01 = COALESCE ( FM35P.BalancePaymentP01, FM36P.BalancePaymentP01, 0 ),
			EmpOutcomePayP01 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP01 = COALESCE ( FM36P.OtherPaymentP01, 0 ),
			TotFundP01 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP01, FM36P.TotFundP01, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP02, FM36P.OnProgPaymentP02, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP02 = COALESCE ( FM35P.LearnSuppPaymentP02, FM36P.LearnSuppPaymentP02, 0 ),
			AchCompPaymentP02 = COALESCE ( FM35P.AchievePaymentP02, FM36P.CompletionPaymentP02, 0 ),
			BalancePaymentP02 = COALESCE ( FM35P.BalancePaymentP02, FM36P.BalancePaymentP02, 0 ),
			EmpOutcomePayP02 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP02 = COALESCE ( FM36P.OtherPaymentP02, 0 ),
			TotFundP02 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP02, FM36P.TotFundP02, HE.GROSSFEE / 12, 0 ),
    '

    SET @SQLString += 
        N'
			OnProgPaymentP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP03, FM36P.OnProgPaymentP03, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP03 = COALESCE ( FM35P.LearnSuppPaymentP03, FM36P.LearnSuppPaymentP03, 0 ),
			AchCompPaymentP03 = COALESCE ( FM35P.AchievePaymentP03, FM36P.CompletionPaymentP03, 0 ),
			BalancePaymentP03 = COALESCE ( FM35P.BalancePaymentP03, FM36P.BalancePaymentP03, 0 ),
			EmpOutcomePayP03 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP03 = COALESCE ( FM36P.OtherPaymentP03, 0 ),
			TotFundP03 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP03, FM36P.TotFundP03, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP04, FM36P.OnProgPaymentP04, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP04 = COALESCE ( FM35P.LearnSuppPaymentP04, FM36P.LearnSuppPaymentP04, 0 ),
			AchCompPaymentP04 = COALESCE ( FM35P.AchievePaymentP04, FM36P.CompletionPaymentP04, 0 ),
			BalancePaymentP04 = COALESCE ( FM35P.BalancePaymentP04, FM36P.BalancePaymentP04, 0 ),
			EmpOutcomePayP04 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP04 = COALESCE ( FM36P.OtherPaymentP04, 0 ),
			TotFundP04 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP04, FM36P.TotFundP04, HE.GROSSFEE / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP05, FM36P.OnProgPaymentP05, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP05 = COALESCE ( FM35P.LearnSuppPaymentP05, FM36P.LearnSuppPaymentP05, 0 ),
			AchCompPaymentP05 = COALESCE ( FM35P.AchievePaymentP05, FM36P.CompletionPaymentP05, 0 ),
			BalancePaymentP05 = COALESCE ( FM35P.BalancePaymentP05, FM36P.BalancePaymentP05, 0 ),
			EmpOutcomePayP05 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP05 = COALESCE ( FM36P.OtherPaymentP05, 0 ),
			TotFundP05 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP05, FM36P.TotFundP05, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP06, FM36P.OnProgPaymentP06, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP06 = COALESCE ( FM35P.LearnSuppPaymentP06, FM36P.LearnSuppPaymentP06, 0 ),
			AchCompPaymentP06 = COALESCE ( FM35P.AchievePaymentP06, FM36P.CompletionPaymentP06, 0 ),
			BalancePaymentP06 = COALESCE ( FM35P.BalancePaymentP06, FM36P.BalancePaymentP06, 0 ),
			EmpOutcomePayP06 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP06 = COALESCE ( FM36P.OtherPaymentP06, 0 ),
			TotFundP06 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP06, FM36P.TotFundP06, HE.GROSSFEE / 12, 0 ),
    '

    SET @SQLString += 
        N'
			OnProgPaymentP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP07, FM36P.OnProgPaymentP07, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP07 = COALESCE ( FM35P.LearnSuppPaymentP07, FM36P.LearnSuppPaymentP07, 0 ),
			AchCompPaymentP07 = COALESCE ( FM35P.AchievePaymentP07, FM36P.CompletionPaymentP07, 0 ),
			BalancePaymentP07 = COALESCE ( FM35P.BalancePaymentP07, FM36P.BalancePaymentP07, 0 ),
			EmpOutcomePayP07 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP07 = COALESCE ( FM36P.OtherPaymentP07, 0 ),
			TotFundP07 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP07, FM36P.TotFundP07, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP08, FM36P.OnProgPaymentP08, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP08 = COALESCE ( FM35P.LearnSuppPaymentP08, FM36P.LearnSuppPaymentP08, 0 ),
			AchCompPaymentP08 = COALESCE ( FM35P.AchievePaymentP08, FM36P.CompletionPaymentP08, 0 ),
			BalancePaymentP08 = COALESCE ( FM35P.BalancePaymentP08, FM36P.BalancePaymentP08, 0 ),
			EmpOutcomePayP08 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP08 = COALESCE ( FM36P.OtherPaymentP08, 0 ),
			TotFundP08 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP08, FM36P.TotFundP08, HE.GROSSFEE / 12, 0 ),
	'

    SET @SQLString += 
        N'
			OnProgPaymentP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP09, FM36P.OnProgPaymentP09, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP09 = COALESCE ( FM35P.LearnSuppPaymentP09, FM36P.LearnSuppPaymentP09, 0 ),
			AchCompPaymentP09 = COALESCE ( FM35P.AchievePaymentP09, FM36P.CompletionPaymentP09, 0 ),
			BalancePaymentP09 = COALESCE ( FM35P.BalancePaymentP09, FM36P.BalancePaymentP09, 0 ),
			EmpOutcomePayP09 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP09 = COALESCE ( FM36P.OtherPaymentP09, 0 ),
			TotFundP09 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP09, FM36P.TotFundP09, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP10, FM36P.OnProgPaymentP10, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP10 = COALESCE ( FM35P.LearnSuppPaymentP10, FM36P.LearnSuppPaymentP10, 0 ),
			AchCompPaymentP10 = COALESCE ( FM35P.AchievePaymentP10, FM36P.CompletionPaymentP10, 0 ),
			BalancePaymentP10 = COALESCE ( FM35P.BalancePaymentP10, FM36P.BalancePaymentP10, 0 ),
			EmpOutcomePayP10 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP10 = COALESCE ( FM36P.OtherPaymentP10, 0 ),
			TotFundP10 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP10, FM36P.TotFundP10, HE.GROSSFEE / 12, 0 ),
    '

    SET @SQLString += 
        N'
			OnProgPaymentP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP11, FM36P.OnProgPaymentP11, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP11 = COALESCE ( FM35P.LearnSuppPaymentP11, FM36P.LearnSuppPaymentP11, 0 ),
			AchCompPaymentP11 = COALESCE ( FM35P.AchievePaymentP11, FM36P.CompletionPaymentP11, 0 ),
			BalancePaymentP11 = COALESCE ( FM35P.BalancePaymentP11, FM36P.BalancePaymentP11, 0 ),
			EmpOutcomePayP11 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP11 = COALESCE ( FM36P.OtherPaymentP11, 0 ),
			TotFundP11 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP11, FM36P.TotFundP11, HE.GROSSFEE / 12, 0 ),

			OnProgPaymentP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.OnProgPaymentP12, FM36P.OnProgPaymentP12, HE.GROSSFEE / 12, 0 ),
			LearnSuppPaymentP12 = COALESCE ( FM35P.LearnSuppPaymentP12, FM36P.LearnSuppPaymentP12, 0 ),
			AchCompPaymentP12 = COALESCE ( FM35P.AchievePaymentP12, FM36P.CompletionPaymentP12, 0 ),
			BalancePaymentP12 = COALESCE ( FM35P.BalancePaymentP12, FM36P.BalancePaymentP12, 0 ),
			EmpOutcomePayP12 = COALESCE ( FM35P.EmpOutcomePayYrEnd, 0 ),
			OtherPaymentP12 = COALESCE ( FM36P.OtherPaymentP12, 0 ),
			TotFundP12 = COALESCE ( CASE WHEN LD.FundModel = ''25'' THEN ( CASE WHEN @Split1619Funding = 1 
				THEN
					CASE
						WHEN COALESCE ( HRS.PLH, 0 ) = 0 THEN CASE WHEN LD.AimSeqNumber = FM25.CoreAimSeqNumber THEN COALESCE ( HRS.Funding, 0 ) ELSE 0 END
						ELSE
							( COALESCE ( HRS.Funding, 0 ) / COALESCE ( HRS.PLH, 0 ) ) * COALESCE ( CASE WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' OR HRS.TFerOnly = 1 THEN PROS.PLH END, 0 )
					END
				ELSE FM25.OnProgPayment END / 12 ) END, FM35P.TotFundP12, FM36P.TotFundP12, HE.GROSSFEE / 12, 0 )

			--INTO FundingDataTemp
	'

    SET @SQLString += 
        N'
		FROM ' + @FISDatabase + '.dbo.Valid_Learner L
		INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_DV_Learner DV
			ON DV.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			ON LD.LearnRefNumber = L.LearnRefNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_DV_LearningDelivery LDR
			ON LDR.LearnRefNumber = LD.LearnRefNumber
			AND LDR.AimSeqNumber = LD.AimSeqNumber
		INNER JOIN ' + @FISDatabase + '.dbo.Valid_Source SRC
			ON 1 = 1
		INNER JOIN ( --Find main dept
			SELECT
				LD.LearnRefNumber,
				FacCode = PSDMD.ProvSpecDelMon,
				CourseCode = PSDMA.ProvSpecDelMon,
				GroupCode = PSDMB.ProvSpecDelMon,
				EnrolmentID = PSDMC.ProvSpecDelMon,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							LD.LearnRefNumber
						ORDER BY
							LD.AimType DESC,
							LD.LearnStartDate DESC,
							LD.CompStatus,
							LD.AimSeqNumber
					)
			FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
		) MA
			On MA.LearnRefNumber = L.LearnRefNumber
			AND MA.RowNum = 1

		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryFAM FFI
			ON FFI.LearnRefNumber = LD.LearnRefNumber
			AND FFI.AimSeqNumber = LD.AimSeqNumber
			AND FFI.LearnDelFAMType = ''FFI''

		LEFT JOIN (
			SELECT
				LearnerRef = EMP.LearnRefNumber,
				EmpStatusCode = EMP.EmpStat,
				EmpStatusName = 
					CASE
						WHEN EMP.EmpStat = ''10'' THEN ''InEmp''
						WHEN EMP.EmpStat = ''11'' THEN ''NoEmpLooking''
						WHEN EMP.EmpStat = ''12'' THEN ''NoEmpNotLooking''
						WHEN EMP.EmpStat = ''98'' THEN ''Unknown''
						ELSE ''Unknown''
					END,
				EmpStatusAppliesDate = EMP.DateEmpStatApp,
				EmployerID = EMP.EmpId,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							EMP.LearnRefNumber
						ORDER BY
							EMP.DateEmpStatApp DESC
					)
			FROM ' + @FISDatabase + '.dbo.Valid_LearnerEmploymentStatus EMP
		) EMP
			ON EMP.LearnerRef = L.LearnRefNumber
			AND EMP.RowNum = 1
		LEFT JOIN (
			SELECT
				PVT.LearnRefNumber,
				PVT.DateEmpStatApp,
				PVT.LOE,
				PVT.LOU,
				PVT.BSI,
				PVT.SEM,
				PVT.SEI,
				PVT.EII,
				RowNum = 
					ROW_NUMBER () OVER (
						PARTITION BY
							PVT.LearnRefNumber
						ORDER BY
							PVT.DateEmpStatApp DESC
					)
			FROM (
				SELECT
					ESM.LearnRefNumber,
					ESM.DateEmpStatApp,
					ESM.ESMType,
					ESM.ESMCode
				FROM ' + @FISDatabase + '.dbo.Valid_EmploymentStatusMonitoring ESM
			) ESM
			PIVOT (
				MAX ( ESMCode )
				FOR ESMType IN ( [LOE], [LOU], [BSI], [SEM], [SEI], [EII] )
			) AS PVT
		) ESM
			ON ESM.LearnRefNumber = L.LearnRefNumber
			AND ESM.RowNum = 1
    '

    SET @SQLString += 
        N'
		LEFT JOIN ( --Partner UKPRN not against prog aim so get this here
			SELECT
				LD.LearnRefNumber,
				LD.PartnerUKPRN,
				RowNum = ROW_NUMBER () OVER (
					PARTITION BY
						LD.LearnRefNumber
					ORDER BY
						LD.CompStatus,
						DATEDIFF ( DAY, LD.LearnStartDate, LD.LearnPlanEndDate ) DESC,
						LD.PartnerUKPRN
				)
			FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			WHERE
				LD.PartnerUKPRN IS NOT NULL
		) PTR
			ON PTR.LearnRefNumber = L.LearnRefNumber
			AND PTR.RowNum = 1

		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
			ON PSDMA.LearnRefNumber = LD.LearnRefNumber
			AND PSDMA.AimSeqNumber = LD.AimSeqNumber
			AND PSDMA.ProvSpecDelMonOccur = ''A''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
			ON PSDMB.LearnRefNumber = LD.LearnRefNumber
			AND PSDMB.AimSeqNumber = LD.AimSeqNumber
			AND PSDMB.ProvSpecDelMonOccur = ''B''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
			ON PSDMC.LearnRefNumber = LD.LearnRefNumber
			AND PSDMC.AimSeqNumber = LD.AimSeqNumber
			AND PSDMC.ProvSpecDelMonOccur = ''C''
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
			ON PSDMD.LearnRefNumber = LD.LearnRefNumber
			AND PSDMD.AimSeqNumber = LD.AimSeqNumber
			AND PSDMD.ProvSpecDelMonOccur = ''D''
	'

    SET @SQLString += 
        N'
		--16-19
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
			ON FM25.LearnRefNumber = LD.LearnRefNumber
			AND FM25.CoreAimSeqNumber = LD.AimSeqNumber
			--AND FM25.StartFund = 1

		--Apps and AEB
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery FM35
			ON FM35.LearnRefNumber = LD.LearnRefNumber
			AND FM35.AimSeqNumber = LD.AimSeqNumber
			--AND FM35.FundStart = 1

		--Loans and Bursaries
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_ALB_LearningDelivery ALB
			ON ALB.LearnRefNumber = LD.LearnRefNumber
			AND ALB.AimSeqNumber = LD.AimSeqNumber

		--Apps Levy/Non-Levy
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery AEC
			ON AEC.LearnRefNumber = LD.LearnRefNumber
			AND AEC.AimSeqNumber = LD.AimSeqNumber

		--Higher Education
		LEFT JOIN ' + @FISDatabase + '.dbo.Valid_LearningDeliveryHE HE
			ON HE.LearnRefNumber = LD.LearnRefNumber
			AND HE.AimSeqNumber = LD.AimSeqNumber
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundToPeriod = SUM ( CASE WHEN FM35P.Period <= @ILRReturn THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePayment6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePay6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFund6Mon = SUM ( CASE WHEN FM35P.Period BETWEEN 1 AND 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentYrEnd = SUM ( FM35P.OnProgPayment ),
				LearnSuppPaymentYrEnd = SUM ( FM35P.LearnSuppFundCash ),
				AchievePaymentYrEnd = SUM ( FM35P.AchievePayment ),
				BalancePaymentYrEnd = SUM ( FM35P.BalancePayment ),
				EmpOutcomePayYrEnd = SUM ( FM35P.EmpOutcomePay ),
				TotFundYrEnd = SUM ( 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay 
				),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP01 = SUM ( CASE WHEN FM35P.Period = 1 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP02 = SUM ( CASE WHEN FM35P.Period = 2 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP03 = SUM ( CASE WHEN FM35P.Period = 3 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP04 = SUM ( CASE WHEN FM35P.Period = 4 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
		'

    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP05 = SUM ( CASE WHEN FM35P.Period = 5 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP06 = SUM ( CASE WHEN FM35P.Period = 6 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP07 = SUM ( CASE WHEN FM35P.Period = 7 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP08 = SUM ( CASE WHEN FM35P.Period = 8 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP09 = SUM ( CASE WHEN FM35P.Period = 9 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP10 = SUM ( CASE WHEN FM35P.Period = 10 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP11 = SUM ( CASE WHEN FM35P.Period = 11 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.OnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.LearnSuppFundCash ELSE 0 END ),
				AchievePaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.AchievePayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.BalancePayment ELSE 0 END ),
				EmpOutcomePayP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN FM35P.EmpOutcomePay ELSE 0 END ),
				TotFundP12 = SUM ( CASE WHEN FM35P.Period = 12 THEN 
					FM35P.OnProgPayment 
					+ FM35P.LearnSuppFundCash
					+ FM35P.AchievePayment
					+ FM35P.BalancePayment
					+ FM35P.EmpOutcomePay
				ELSE 0 END )
			FROM ' + @FISDatabase + '.dbo.Rulebase_SFA_LearningDelivery_Period FM35P
			GROUP BY
				FM35P.LearnRefNumber,
				FM35P.AimSeqNumber
		) FM35P
			ON FM35P.LearnRefNumber = FM35.LearnRefNumber
			AND FM35P.AimSeqNumber = FM35.AimSeqNumber
	'

    SET @SQLString += 
        N'
		--FW Standards
		LEFT JOIN ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery FM36
			ON FM36.LearnRefNumber = LD.LearnRefNumber
			AND FM36.AimSeqNumber = LD.AimSeqNumber
		LEFT JOIN (
			SELECT
				FM36PE.LearnRefNumber,
				AimSeqNumber = FM36PE.PriceEpisodeAimSeqNumber,
				FM36PE.EpisodeStartDate,
				FM36PE.PriceEpisodeTotalTNPPrice,
				FM36PE.PriceEpisodeCompletionElement,
				FM36PE.PriceEpisodeTotalPMRs,
				FM36PE.PriceEpisodeCumulativePMRs,
				RowNum =
					ROW_NUMBER () OVER (
						PARTITION BY
							FM36PE.LearnRefNumber,
							FM36PE.PriceEpisodeAimSeqNumber
						ORDER BY
							FM36PE.EpisodeStartDate DESC
					)
			FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_ApprenticeshipPriceEpisode FM36PE
				--AND FM36PE.EpisodeStartDate = FM36.AppAdjLearnStartDate
			WHERE
				FM36PE.EpisodeStartDate < ''20'' + RIGHT ( @AcademicYear, 2 ) + ''-08-01''
		) FM36PE
			ON FM36PE.LearnRefNumber = FM36.LearnRefNumber
			AND FM36PE.AimSeqNumber = FM36.AimSeqNumber
			AND FM36PE.RowNum = 1
	'

    SET @SQLString += 
        N'
		LEFT JOIN (
			SELECT
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber,

				OnProgPaymentToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundToPeriod = SUM ( CASE WHEN FM36P.Period <= @ILRReturn THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPayment6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPayment6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPayment6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePayment6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPayment6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFund6Mon = SUM ( CASE WHEN FM36P.Period BETWEEN 1 AND 6 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentYrEnd = SUM ( FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ),
				LearnSuppPaymentYrEnd = SUM ( FM36P.LearnSuppFundCash ),
				CompletionPaymentYrEnd = SUM ( FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ),
				BalancePaymentYrEnd = SUM ( FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ),
				OtherPaymentYrEnd = SUM (
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				 ),
				TotFundYrEnd = SUM ( 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
					),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP01 = SUM ( CASE WHEN FM36P.Period = 1 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP02 = SUM ( CASE WHEN FM36P.Period = 2 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
		'

    SET @SQLString += 
        N'
				OnProgPaymentP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP03 = SUM ( CASE WHEN FM36P.Period = 3 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP04 = SUM ( CASE WHEN FM36P.Period = 4 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP05 = SUM ( CASE WHEN FM36P.Period = 5 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP06 = SUM ( CASE WHEN FM36P.Period = 6 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
    '

    SET @SQLString += 
        N'
				OnProgPaymentP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP07 = SUM ( CASE WHEN FM36P.Period = 7 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP08 = SUM ( CASE WHEN FM36P.Period = 8 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
	'

    SET @SQLString += 
        N'
				OnProgPaymentP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP09 = SUM ( CASE WHEN FM36P.Period = 9 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP10 = SUM ( CASE WHEN FM36P.Period = 10 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
	'

    SET @SQLString += 
        N'
				OnProgPaymentP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP11 = SUM ( CASE WHEN FM36P.Period = 11 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),

				OnProgPaymentP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN FM36P.ProgrammeAimOnProgPayment + FM36P.MathEngOnProgPayment + FM36P.LDApplic1618FrameworkUpliftOnProgPayment ELSE 0 END ),
				LearnSuppPaymentP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN FM36P.LearnSuppFundCash ELSE 0 END ),
				CompletionPaymentP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN FM36P.ProgrammeAimCompletionPayment + FM36P.LDApplic1618FrameworkUpliftCompletionPayment ELSE 0 END ),
				BalancePaymentP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN FM36P.ProgrammeAimBalPayment + FM36P.MathEngBalPayment + FM36P.LDApplic1618FrameworkUpliftBalancingPayment ELSE 0 END ),
				OtherPaymentP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN 
					FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END ),
				TotFundP12 = SUM ( CASE WHEN FM36P.Period = 12 THEN 
					FM36P.ProgrammeAimOnProgPayment 
					+ FM36P.MathEngOnProgPayment 
					+ FM36P.LDApplic1618FrameworkUpliftOnProgPayment
					+ FM36P.LearnSuppFundCash 
					+ FM36P.ProgrammeAimCompletionPayment
					+ FM36P.LDApplic1618FrameworkUpliftCompletionPayment
					+ FM36P.ProgrammeAimBalPayment 
					+ FM36P.MathEngBalPayment 
					+ FM36P.LDApplic1618FrameworkUpliftBalancingPayment
					+ FM36P.DisadvFirstPayment 
					+ FM36P.DisadvSecondPayment
					+ FM36P.LearnDelFirstProv1618Pay 
					+ FM36P.LearnDelSecondProv1618Pay
				ELSE 0 END )
			FROM ' + @FISDatabase + '.dbo.Rulebase_AEC_LearningDelivery_Period FM36P
			GROUP BY
				FM36P.LearnRefNumber,
				FM36P.AimSeqNumber
		) FM36P
			ON FM36P.LearnRefNumber = FM36.LearnRefNumber
			AND FM36P.AimSeqNumber = FM36.AimSeqNumber
	'

    SET @SQLString += 
        N'
		--Invalid Learners
		LEFT JOIN (
			SELECT
				InvalidLearners = COUNT ( L.Learner_Id )
			FROM ' + @FISDatabase + '.dbo.Invalid_Learner L
		) INV
			ON 1 = 1

		--ProGeneral Data
		LEFT JOIN (
			SELECT DISTINCT
				FW.Framework_Code,
				FW.Framework_Desc
			FROM ' + @ProAchieveDatabaseLocation + 'Frameworks_QSR FW
		) FW
			ON FW.Framework_Code = LD.FworkCode
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PostCodeWard PCW
			ON PCW.Postcode = L.Postcode
		LEFT JOIN ' + @ProAchieveDatabaseLocation + 'PostCodeUplift PCU
			ON PCU.POSTCODE = L.Postcode

		--ProSolution Data
		LEFT JOIN (
			SELECT DISTINCT
				ProvSpecField = 
					CASE 
						WHEN ' + @ProviderFieldCourseFormat + ' IS NOT NULL THEN ' + @ProviderFieldCourseFormat + '
						ELSE CRS.Code
					END,
				CourseCode = CRS.Code,
				CourseTitle = CRS.Name,
				PLH = CRS.PlannedLearningHours1618,
				EEP = CRS.PlannedEEPHours1618,
				SiteCode = STE.Code,
				SiteName = STE.Description,
				FacCode = 
					CASE
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%English%'' THEN COALESCE ( FENG.Code, FAC.Code )
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%Math%'' THEN COALESCE ( FMAT.Code, FAC.Code )
						ELSE FAC.Code
					END,
				FacName = 
					CASE
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%English%'' THEN COALESCE ( FENG.Name, FAC.Name, ''-- Unknown --'' )
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%Math%'' THEN COALESCE ( FMAT.Name, FAC.Name, ''-- Unknown --'' )
						ELSE COALESCE ( FAC.Name, ''-- Unknown --'' )
					END,
				TeamCode = 
					CASE
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%English%'' THEN COALESCE ( TENG.Code, TEAM.Code )
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%Math%'' THEN COALESCE ( TMAT.Code, TEAM.Code )
						ELSE TEAM.Code
					END,
				TeamName = 
					CASE
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%English%'' THEN COALESCE ( TENG.Name, TEAM.Name, ''-- Unknown --'' )
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%Math%'' THEN COALESCE ( TMAT.Name, TEAM.Name, ''-- Unknown --'' )
						ELSE COALESCE ( TEAM.Name, ''-- Unknown --'' )
					END,
				CostCentre = 
					CASE
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%English%'' THEN COALESCE ( CASE WHEN @OverrideEngCostCentre <> ''NULL'' THEN @OverrideEngCostCentre END, CRS.LedgerCode )
						WHEN AIM.LEARNING_AIM_TYPE_CODE IN ( ''0003'', ''2999'', ''1439'' ) AND AIM.LEARNING_AIM_TITLE LIKE ''%Math%'' THEN COALESCE ( CASE WHEN @OverrideMatCostCentre <> ''NULL'' THEN @OverrideMatCostCentre END, CRS.LedgerCode )
						ELSE CRS.LedgerCode
					END,
				FacCodePartner = COALESCE ( FPAR.Code, @OverridePartnerFac, FAC.Code ),
				FacNamePartner = COALESCE ( FPAR.Name, CASE WHEN @OverridePartnerFac <> ''NULL'' THEN ''Subcontractors'' END, ''-- Unknown --'' ),
				TeamCodePartner = COALESCE ( TPAR.Code, @OverridePartnerTeam, TEAM.Code ),
				TeamNamePartner = COALESCE ( TPAR.Name, CASE WHEN @OverridePartnerTeam <> ''NULL'' THEN ''Subcontractors'' END, ''-- Unknown --'' ),
				CostCentrePartner = COALESCE ( CASE WHEN @OverridePartnerCostCentre <> ''NULL'' THEN @OverridePartnerCostCentre END, CRS.LedgerCode ),
				CostCentreOrig = CRS.LedgerCode,
				FacCodeOrig = FAC.Code,
				FacNameOrig = COALESCE ( FAC.Name, ''-- Unknown --'' ),
				TeamCodeOrig = TEAM.Code,
				TeamNameOrig = COALESCE ( TEAM.Name, ''-- Unknown --'' )
    '

    SET @SQLString += 
        N'
			FROM ' + @ProSolutionDatabaseLocation + 'Offering CRS
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Learning_Aim AIM
				ON AIM.LEARNING_AIM_REF = CRS.QualID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Site STE
				ON STE.SiteID = CRS.SiteID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel TEAM
				ON TEAM.SID = CRS.SID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel FAC
				ON FAC.SID = TEAM.ParentSID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel TENG
				ON TENG.Code = @OverrideEngTeam
				AND COALESCE ( TENG.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel TMAT
				ON TMAT.Code = @OverrideMatTeam
				AND COALESCE ( TMAT.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel FENG
				ON FENG.Code = @OverrideEngFac
				AND COALESCE ( FENG.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel FMAT
				ON FMAT.Code = @OverrideMatFac
				AND COALESCE ( FMAT.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'OfferingGroup GRP
				ON GRP.OfferingID = CRS.OfferingID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel TPAR
				ON TPAR.Code = @OverridePartnerTeam
				AND COALESCE ( TPAR.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel FPAR
				ON FPAR.Code = @OverridePartnerFac
				AND COALESCE ( FPAR.MaxAcademicYearID, @AcademicYear ) >= @AcademicYear
			WHERE
				CRS.AcademicYearID = @AcademicYear
		) PROS
			ON PROS.ProvSpecField = PSDM' + @ProviderFieldCourseLocation + '.ProvSpecDelMon
		LEFT JOIN (
			SELECT DISTINCT
				ProvSpecField = 
					CASE 
						WHEN ' + @ProviderFieldCourseFormat + ' IS NOT NULL THEN ' + @ProviderFieldCourseFormat + '
						ELSE CRS.Code
					END,
				CourseCode = CRS.Code,
				CourseTitle = CRS.Name,
				SiteCode = STE.Code,
				SiteName = STE.Description,
				FacCode = FAC.Code,
				FacName = COALESCE ( FAC.Name, ''-- Unknown --'' ),
				TeamCode = TEAM.Code,
				TeamName = COALESCE ( TEAM.Name, ''-- Unknown --'' ),
				CostCentre = CRS.LedgerCode
			FROM ' + @ProSolutionDatabaseLocation + 'Offering CRS
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Site STE
				ON STE.SiteID = CRS.SiteID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel TEAM
				ON TEAM.SID = CRS.SID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'CollegeLevel FAC
				ON FAC.SID = TEAM.ParentSID
			LEFT JOIN ' + @ProSolutionDatabaseLocation + 'OfferingGroup GRP
				ON GRP.OfferingID = CRS.OfferingID
			WHERE
				CRS.AcademicYearID = @AcademicYear
		) PROSM
			ON PROSM.ProvSpecField = MA.CourseCode
	'

    SET @SQLString += 
        N'
		--ProSolution FM25 for counting hours
		LEFT JOIN (
			SELECT
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				TFerOnly = CASE WHEN ACT.LearnRefNumber IS NULL THEN 1 ELSE 0 END,
				PLH = COALESCE ( SUM ( PROS.PLH ), 0 ),
				EEP = COALESCE ( SUM ( PROS.EEP ), 0 ),
				Funding = MAX ( FM25.OnProgPayment ),
				IsFunded = MAX ( CAST ( FM25.StartFund AS INT ) )
			FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
			INNER JOIN ' + @FISDatabase + '.dbo.Rulebase_EFA_Learner FM25
				ON FM25.LearnRefNumber = LD.LearnRefNumber
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMA
				ON PSDMA.LearnRefNumber = LD.LearnRefNumber
				AND PSDMA.AimSeqNumber = LD.AimSeqNumber
				AND PSDMA.ProvSpecDelMonOccur = ''A''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMB
				ON PSDMB.LearnRefNumber = LD.LearnRefNumber
				AND PSDMB.AimSeqNumber = LD.AimSeqNumber
				AND PSDMB.ProvSpecDelMonOccur = ''B''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMC
				ON PSDMC.LearnRefNumber = LD.LearnRefNumber
				AND PSDMC.AimSeqNumber = LD.AimSeqNumber
				AND PSDMC.ProvSpecDelMonOccur = ''C''
			LEFT JOIN ' + @FISDatabase + '.dbo.Valid_ProviderSpecDeliveryMonitoring PSDMD
				ON PSDMD.LearnRefNumber = LD.LearnRefNumber
				AND PSDMD.AimSeqNumber = LD.AimSeqNumber
				AND PSDMD.ProvSpecDelMonOccur = ''D''
			LEFT JOIN (
				SELECT DISTINCT
					ProvSpecField = 
						CASE 
							WHEN ' + @ProviderFieldCourseFormat + ' IS NOT NULL THEN ' + @ProviderFieldCourseFormat + '
							ELSE CRS.Code
						END,
					CourseCode = CRS.Code,
					PLH = CRS.PlannedLearningHours1618,
					EEP = CRS.PlannedEEPHours1618
				FROM ' + @ProSolutionDatabaseLocation + 'Offering CRS
				LEFT JOIN ' + @ProSolutionDatabaseLocation + 'OfferingGroup GRP
					ON GRP.OfferingID = CRS.OfferingID
				WHERE
					CRS.AcademicYearID = @AcademicYear
			) PROS
			ON PROS.ProvSpecField = 
                CASE
                    WHEN @ProviderFieldCourseLocation = ''A'' THEN
                        PSDMA.ProvSpecDelMon
                    WHEN @ProviderFieldCourseLocation = ''B'' THEN
                        PSDMB.ProvSpecDelMon
                    WHEN @ProviderFieldCourseLocation = ''C'' THEN
                        PSDMC.ProvSpecDelMon
                    WHEN @ProviderFieldCourseLocation = ''D'' THEN
                        PSDMD.ProvSpecDelMon
                    ELSE 
                        PSDMA.ProvSpecDelMon
                END
			LEFT JOIN (
				SELECT DISTINCT
					LD.LearnRefNumber
				FROM ' + @FISDatabase + '.dbo.Valid_LearningDelivery LD
				WHERE
					LD.FundModel = ''25''
					AND COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' --Exclude transfers
					--AND LD.LearnRefNumber = ''17002435''
				GROUP BY
					LD.LearnRefNumber
			) ACT
				ON ACT.LearnRefNumber = LD.LearnRefNumber
			WHERE
				LD.FundModel = ''25''
				--AND LD.LearnRefNumber = ''18000292''
				AND 
					CASE --If lrn has no active aims then count tfer instead
						WHEN ACT.LearnRefNumber IS NOT NULL THEN
							CASE
								WHEN COALESCE ( LD.WithdrawReason, ''0'' ) <> ''40'' THEN 1
								ELSE 0
							END
						ELSE
							1
						END = 1
			GROUP BY
				LD.LearnRefNumber,
				FM25.FundLine,
				FM25.RateBand,
				ACT.LearnRefNumber
		) HRS
			ON HRS.LearnRefNumber = L.LearnRefNumber
    '

    SET @SQLString += 
        N'
		LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Learning_Aim AIM
			ON AIM.LEARNING_AIM_REF = LD.LearnAimRef
		LEFT JOIN ' + @ProSolutionDatabaseLocation + 'SSA1 SSA1
			ON SSA1.SSA_Tier1_code = AIM.SSA1ID
		LEFT JOIN ' + @ProSolutionDatabaseLocation + 'SSA2 SSA2
			ON SSA2.SSA_Tier2_code = AIM.SSA2ID
		LEFT JOIN (
			SELECT
				EmployerID = CAST ( ORG.EDRSRef AS INT ),
				OrganisationID = MIN ( ORG.OrganisationID )
			FROM ' + @ProSolutionDatabaseLocation + 'Organisation ORG
			WHERE
				ORG.Active = 1
				--AND ORG.OrganisationTypeID = 3
				AND ORG.EDRSRef IS NOT NULL
				AND LEN ( LTRIM ( RTRIM ( ORG.EDRSRef ) ) ) = 9
			GROUP BY
				ORG.EDRSRef
		) MEMP
			ON MEMP.EmployerID = LDR.LearnDel_EmpID
		LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Organisation EMPN
			ON EMPN.OrganisationID = MEMP.OrganisationID
		LEFT JOIN ' + @ProSolutionDatabaseLocation + 'Organisation PTN
			ON CAST ( COALESCE ( PTN.FranchPartnerRef, PTN.UKPRN, PTN.OrganisationRef ) AS INT ) = 
				CASE
					WHEN LD.LearnAimRef = ''ZPROG001'' THEN PTR.PartnerUKPRN
					ELSE LD.PartnerUKPRN
				END
			AND LEN ( LTRIM ( RTRIM ( COALESCE ( PTN.FranchPartnerRef, PTN.UKPRN, PTN.OrganisationRef ) ) ) ) = 8

		--WHERE
		--	L.LearnRefNumber = ''11024003''
		--ORDER BY
		--	PROS.SiteCode,
		--	PSDMD.ProvSpecDelMon,
		--	PROS.TeamCode,
		--	PSDMA.ProvSpecDelMon,
		--	PSDMB.ProvSpecDelMon,
		--	L.FamilyName,
		--	L.GivenNames,
		--	L.LearnRefNumber';

	SET @SQLParams = 
        N'@AcademicYear NVARCHAR(5),
    	@ILRReturn NVARCHAR(2),
    	@IsFinalReturn bit,
    	@Split1619Funding bit,
    	@FutureAchieveWeighting DECIMAL(3,2),
    	@ProviderFieldCourseLocation CHAR(1),
    	@ProviderFieldCourseFormat NVARCHAR(50),
    	@OverrideEngFac NVARCHAR(50),
    	@OverrideMatFac NVARCHAR(50),
    	@OverrideEngTeam NVARCHAR(50),
    	@OverrideMatTeam NVARCHAR(50),
    	@OverrideEngCostCentre NVARCHAR(50),
    	@OverrideMatCostCentre NVARCHAR(50),
    	@OverridePartnerFac NVARCHAR(50),
    	@OverridePartnerTeam NVARCHAR(50),
    	@OverridePartnerCostCentre NVARCHAR(50)';
    
    EXECUTE sp_executesql 
        @SQLString, 
        @SQLParams, 
        @AcademicYear = @AcademicYear,
    	@ILRReturn = @ILRReturn,
    	@IsFinalReturn = @IsFinalReturn,
    	@Split1619Funding = @Split1619Funding,
    	@FutureAchieveWeighting = @FutureAchieveWeighting,
    	@ProviderFieldCourseLocation = @ProviderFieldCourseLocation,
    	@ProviderFieldCourseFormat = @ProviderFieldCourseFormat,
    	@OverrideEngFac = @OverrideEngFac,
    	@OverrideMatFac = @OverrideMatFac,
    	@OverrideEngTeam = @OverrideEngTeam,
    	@OverrideMatTeam = @OverrideMatTeam,
    	@OverrideEngCostCentre = @OverrideEngCostCentre,
    	@OverrideMatCostCentre = @OverrideMatCostCentre,
    	@OverridePartnerFac = @OverridePartnerFac,
    	@OverridePartnerTeam = @OverridePartnerTeam,
    	@OverridePartnerCostCentre = @OverridePartnerCostCentre;
END